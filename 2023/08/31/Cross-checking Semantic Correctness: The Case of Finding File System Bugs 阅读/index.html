<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8"/>
    <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
    <title>
      
        Cross-checking Semantic Correctness: The Case of Finding File System Bugs 阅读 | ZPF.SITE
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png"/>
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color=""/>
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/regular.ttf);
        font-weight: regular;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css'/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css" />
  

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg"/>
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/CS&Maths">Computer Science & Maths</a>
            
              <a class="nav-menu-item" href="/Life">Life</a>
            
          
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner--toc">
      <div class="post-content__head">
        <div class="post-title">Cross-checking Semantic Correctness: The Case of Finding File System Bugs 阅读</div>
        <div class="post-info">
          
  <a href="/tags/Linux/" class="post-tag">#Linux</a><a href="/tags/File-System/" class="post-tag">#File System</a><a href="/tags/Paper/" class="post-tag">#Paper</a><a href="/tags/Symbolic-Execution/" class="post-tag">#Symbolic Execution</a><a href="/tags/Staitc-Analysis/" class="post-tag">#Staitc Analysis</a><a href="/tags/SOSP/" class="post-tag">#SOSP</a><a href="/tags/SOSP-15/" class="post-tag">#SOSP'15</a>


          <span class="post-date">2023-08-31</span>
        </div>
      </div>
      
        <aside class="toc-outer">
          <div class="toc-title">目录</div>
          <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AE%BE%E8%AE%A1"><span class="post-toc-text">设计</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%97%AE%E9%A2%98"><span class="post-toc-text">问题</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%A4%8D%E7%8E%B0"><span class="post-toc-text">实验复现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="post-toc-text">实验环境</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A4%8D%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="post-toc-text">复现步骤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%8B%E8%BD%BD-juxta"><span class="post-toc-text">下载 juxta</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%B5%8B%E8%AF%95-linux"><span class="post-toc-text">下载并测试 Linux</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BC%96%E8%AF%91-clang"><span class="post-toc-text">编译 clang</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%9E%84%E5%BB%BA-path-database"><span class="post-toc-text">构建 path database</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#code-checker"><span class="post-toc-text">code checker</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#get-sorted-results-of-checker-output"><span class="post-toc-text">get sorted results of checker output</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="post-toc-text">代码分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="post-toc-text">目录结构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ctrl.py-%E6%96%87%E4%BB%B6"><span class="post-toc-text">ctrl.py 文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#merge-%E6%93%8D%E4%BD%9C"><span class="post-toc-text">merge 操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#clang-%E6%93%8D%E4%BD%9C%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="post-toc-text">clang 操作（静态分析）</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#merger.py-%E6%96%87%E4%BB%B6"><span class="post-toc-text">merger.py 文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#merge_fs-%E5%87%BD%E6%95%B0"><span class="post-toc-text">merge_fs 函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#preprocess-%E5%87%BD%E6%95%B0"><span class="post-toc-text">preprocess 函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#preprocess_headers-%E5%87%BD%E6%95%B0"><span class="post-toc-text">preprocess_headers 函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#rewrite-%E5%87%BD%E6%95%B0"><span class="post-toc-text">rewrite 函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#prepare_rewritting-%E5%87%BD%E6%95%B0"><span class="post-toc-text">prepare_rewritting 函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#staticdecl-%E7%B1%BB"><span class="post-toc-text">StaticDecl 类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#tokenrewritter-%E7%B1%BB"><span class="post-toc-text">TokenRewritter 类</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#clang-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="post-toc-text">Clang 相关代码解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#options.td-%E6%96%87%E4%BB%B6"><span class="post-toc-text">Options.td 文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#fss-build-%E8%84%9A%E6%9C%AC"><span class="post-toc-text">fss-build 脚本</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#fssccc-analyzer-%E4%B8%8E-fssc-analyzer-%E8%84%9A%E6%9C%AC"><span class="post-toc-text">fssccc-analyzer 与 fssc++-analyzer 脚本</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="post-toc-text">结果分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%94%B9%E8%BF%9B"><span class="post-toc-text">改进</span></a></li></ol>
          <a href="#" class="toc-top">回到顶部</a>
        </aside>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <p>主要思路是统计多个文件系统的实现，计算具体文件系统与多个文件系统总体之间的差异性（直方图/信息熵），从而窥探出其文件系统的具体实现在语义上的差异。 <span id="more"></span></p>
<h2 id="设计">设计</h2>
<figure>
<img src="/Cross-checking%20Semantic%20Correctness:%20The%20Case%20of%20Finding%20File%20System%20Bugs%20阅读/image1.png" alt="" /><figcaption>Overview</figcaption>
</figure>
<ol type="1">
<li>To enable comparison, the source code of each file system is merged into one large file. This allows interprocedural analysis within a file system.</li>
<li>JUXTA collects execution information for each function in the file systems by constructing control-flow graphs (CFGs) and symbolically exploring these graphs from the entry point to the end of each function.</li>
<li>Symbols are canonicalized so that equivalent symbols have the same name across file systems. A path database that stores the extracted path information is also created, which allows applications like checkers and specification extractors to use the path information without reexecuting symbolic analysis. All of these facilitate comparison.</li>
<li>Symbolic execution is used to explore paths through functions and build a path database. The path info contains path conditions, return values, side effects, etc.</li>
<li>Two statistical methods are used to compare paths:
<ul>
<li>Histogram-based: Integer ranges are encoded into histograms and distances between histograms are computed.</li>
<li>Entropy-based: Used for <strong>events</strong> like flags or return value checks. Low non-zero entropy indicates a likely bug.（别的的实现均不包含这一event，则说明this event could be wrong implementation）</li>
</ul></li>
</ol>
<figure>
<img src="/Cross-checking%20Semantic%20Correctness:%20The%20Case%20of%20Finding%20File%20System%20Bugs%20阅读/image2.png" alt="" /><figcaption>Histogram-based comparison</figcaption>
</figure>
<ol start="6" type="1">
<li>Bug reports are ranked to prioritize investigation of likely true positives. Metrics include histogram distance and entropy values.</li>
</ol>
<h2 id="实现">实现</h2>
<p>需要构建8个检查器：</p>
<ol type="1">
<li>返回值检查器：比较不同文件系统对同一VFS接口的返回值，找到返回值有明显差异的文件系统。</li>
<li>副作用检查器：比较同一VFS接口和返回值下的副作用，找到副作用有明显差异的文件系统。</li>
<li>函数调用检查器：比较同一VFS接口下的函数调用，找到调用函数有明显差异的文件系统。</li>
<li>路径条件检查器：比较同一VFS接口下的路径条件，找到路径条件有明显差异的文件系统。</li>
<li>提取文件系统规范：从不同文件系统中提取出共性行为作为潜在规范。</li>
<li>重构跨模块抽象：根据共性行为，可将其提升到VFS层，减少冗余。</li>
<li>推断锁语义：推断每个路径所持有和释放的锁，跟踪受锁保护的字段。</li>
<li>推断外部API语义：基于调用参数和返回值检查的频率分布，找出用法有明显差异的文件系统。</li>
</ol>
<h2 id="问题">问题</h2>
<ol type="1">
<li>依赖于大量实现相同功能的模块</li>
</ol>
<h2 id="实验复现">实验复现</h2>
<h3 id="实验环境">实验环境</h3>
<ul>
<li>docker ubuntu 14.04</li>
<li>gcc 4.8</li>
<li>g++ 4.8</li>
</ul>
<h3 id="复现步骤">复现步骤</h3>
<h4 id="下载-juxta">下载 juxta</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/sslab-gatech/juxta.git<br></code></pre></td></tr></table></figure>
<h4 id="下载并测试-linux">下载并测试 Linux</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/torvalds/linux.git<br>cd linux<br>git checkout v4.0-rc2<br>cp ../juxta/config/config-x86_64-full-fs-4.0 .config<br>make; make clean<br>cd ../juxta<br></code></pre></td></tr></table></figure>
<h4 id="编译-clang">编译 clang</h4>
<p>在编译 clang 之前在 juxta 的 <code>Makefile</code> 中增加<code>COMPILER := -DCMAKE_CXX_COMPILER=g++-4.8 -DCMAKE_C_COMPILER=gcc-4.8</code>，并且将其添加到 cmake 的参数中。 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">make clang-full       # first time only<br>make clang            # from the next<br></code></pre></td></tr></table></figure></p>
<h4 id="构建-path-database">构建 path database</h4>
<p>合并文件系统代码 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd analyzer<br>./ctrl.py merge_all   # for all file systems<br>./ctrl.py merge ext4  # for ext4<br></code></pre></td></tr></table></figure></p>
<p>对合并的文件系统代码静态分析 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">./ctrl.py clang_all   # for all file systems<br>./ctrl.py clang ext4  # for ext4<br></code></pre></td></tr></table></figure></p>
<p>构建路径数据库 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./ctrl.py pickle_all  # for all file systems<br></code></pre></td></tr></table></figure></p>
<h4 id="code-checker">code checker</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">./ckrtn.py            # Return code checker<br>./ckstore.py          # Side-effect checker<br>./ckcall.py           # Function call checker<br>./ckcond.py           # Path condition checker<br>./call_flags.py       # Argument checker<br>./ckapi.py            # Error handling checker<br>./lock.py             # Lock checker<br>./spec.py             # Spec. generator<br></code></pre></td></tr></table></figure>
<h4 id="get-sorted-results-of-checker-output">get sorted results of checker output</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./catcklog.sh [checker output dir]<br></code></pre></td></tr></table></figure>
<h2 id="代码分析">代码分析</h2>
<h3 id="目录结构">目录结构</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.<br>|-- LICENSE<br>|-- Makefile<br>|-- README.md<br>|-- analyzer  // 代码分析工具<br>|-- bin<br>|-- config    // 保存有Linux的编译配置<br>|-- llvm      // llvm的源码<br>`-- scripts<br></code></pre></td></tr></table></figure>
<p>analyzer目录如下所示： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.<br>|-- NOTE.fops-3.17      // 整理了对文件系统的操作<br>|-- NOTE.fops-4.0<br>|-- NOTE.fs<br>|-- README<br>|-- _eval-grep-count.sh<br>|-- analyzer.py<br>|-- api_parser.py<br>|-- argnorm.py<br>|-- batch_bug_dist.py<br>|-- bug_dist.py<br>|-- bugginess.py<br>|-- call_flags.py<br>|-- catckfn.sh<br>|-- catcklog.sh<br>|-- checker.py<br>|-- ckapi.py<br>|-- ckcall.py<br>|-- ckcond.py<br>|-- ckrtn.py<br>|-- ckstore.py<br>|-- color.py<br>|-- condition_container.py<br>|-- ctrl.py<br>|-- data<br>|-- dbg.py<br>|-- dump-ast.py<br>|-- eval-count.py<br>|-- eval-grep-count.py<br>|-- fgrep.py<br>|-- fsop.py<br>|-- inc<br>|-- libs<br>|-- lock.py<br>|-- lock_promo.py<br>|-- lock_promo_check.py<br>|-- lock_range.py<br>|-- lock_range_cmp.py<br>|-- merger.py<br>|-- mining.py<br>|-- ops.py<br>|-- parser.py<br>|-- path.py<br>|-- path_container.py<br>|-- pathbin.py<br>|-- pickler.py<br>|-- proof.z3.template<br>|-- pygments -&gt; libs/pygments/pygments<br>|-- pymake -&gt; libs/pymake/pymake<br>|-- return_cond.py<br>|-- return_cond_container.py<br>|-- rsf.py<br>|-- rsv.py<br>|-- scripts<br>|-- spec.py<br>|-- utils.py<br>|-- z3 -&gt; libs/z3<br>`-- z3helper.py<br></code></pre></td></tr></table></figure></p>
<h3 id="ctrl.py-文件">ctrl.py 文件</h3>
<p>主要功能包括：</p>
<ul>
<li>merge：将多个文件系统的源代码合并成一个文件，方便进行静态分析。</li>
<li>clang：使用Clang对合并后的代码进行静态分析，生成结果文件。</li>
<li>grep_decl：搜索并输出文件系统的常见操作函数声明。</li>
<li>analyze_lock：分析文件系统对锁的使用情况。</li>
<li>analyze_lock_range：分析文件系统锁的作用范围。</li>
<li>analyze_lock_promo：分析文件系统锁的提升情况。</li>
<li>status：显示文件合并和静态分析的状态。</li>
</ul>
<p>主要流程：</p>
<ul>
<li>通过merge命令将多个文件系统的源代码合并成一个文件，存放在out目录下。</li>
<li>通过clang命令使用Clang对合并后的代码进行静态分析，生成结果文件存放在clang-log目录下。</li>
<li>分析脚本从clang-log目录读取结果文件，进行各种分析，如锁使用分析等，结果输出到results目录下。</li>
<li>status命令可以查看合并和分析的状态。</li>
</ul>
<h4 id="merge-操作">merge 操作</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_merge</span>(<span class="hljs-params">opts, args</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;merge fs specified (e.g., &#x27;merge ext3 ext4&#x27;)&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">import</span> merger<br>    <span class="hljs-keyword">for</span> fs <span class="hljs-keyword">in</span> args:<br>        merger.merge_fs(opts, fs)<br></code></pre></td></tr></table></figure>
<p>当执行<code>./ctrl.py merge ext3</code>的时候，调用这里的<code>cmd_merge</code>函数，该函数调用下文写到的<code>merger</code>模块中的<code>merge_fs</code>函数，实现文件系统的合并。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_merge_all</span>(<span class="hljs-params">opts, _</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;merge all fs (e.g., &#x27;merge_all&#x27;)&quot;&quot;&quot;</span><br><br>    pool = mp.Pool(mp.cpu_count())<br>    <span class="hljs-keyword">for</span> fs <span class="hljs-keyword">in</span> fsop.get_fs(<span class="hljs-string">&quot;M&quot;</span>):<br>        pool.apply_async(_run_merger, args = (fs, opts.linux))<br>    pool.close()<br>    pool.join()<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p><code>./ctrl.py merge_all</code>的情况则更为复杂一点。通过调用<code>fsop.get_fs</code>函数来获得需要被合并的文件列表。</p>
<p><code>fsop</code>的<code>get_fs</code>函数如下所示，先读取<code>analyzer</code>目录下的<code>NOTE.fs</code>文件，从中获得内容的格式为 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[配置参数] 键名 其他文本<br></code></pre></td></tr></table></figure></p>
<p><code>配置参数</code>有</p>
<ul>
<li>M: known to be merged as a single code</li>
<li>C: known to run it with clang pass</li>
<li>F: failed with clang pass</li>
</ul>
<p>此处<code>get_fs</code>将配置参数为<code>M</code>的文件系统列表返回给<code>cmd_merge_all</code>，<code>cmd_merge_all</code>并行进行文件系统合并。 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">ROOT = os.path.dirname(__file__)<br><br><span class="hljs-comment"># XXX. hide</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_conf</span>(<span class="hljs-params">pn</span>):<br>    conf = []<br>    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">open</span>(pn):<br>        m = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">&quot;\[([\\w ]*)\] (\\w+).*&quot;</span>, l)<br>        <span class="hljs-keyword">if</span> m:<br>            tok = m.groups()<br>            conf.append((tok[<span class="hljs-number">0</span>].strip(), tok[<span class="hljs-number">1</span>]))<br>    <span class="hljs-keyword">return</span> conf<br><br><span class="hljs-keyword">global</span> CONF<br>CONF = load_conf(os.path.join(ROOT, <span class="hljs-string">&quot;NOTE.fs&quot;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_fs</span>(<span class="hljs-params">kind</span>):<br>    <span class="hljs-keyword">global</span> CONF<br>    rtn = []<br>    <span class="hljs-keyword">for</span> (tag, fs) <span class="hljs-keyword">in</span> CONF:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(t <span class="hljs-keyword">in</span> tag <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> kind):<br>            rtn.append(fs)<br>    <span class="hljs-keyword">return</span> rtn<br></code></pre></td></tr></table></figure> 以ext3文件系统为例，执行完merge操作后的<code>out/ext3</code>目录下的文件如下所示： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.<br>|-- Kconfig<br>|-- Makefile<br>|-- Makefile.build<br>|-- acl.h<br>|-- ext3.h<br>|-- namei.h<br>|-- one.c<br>|-- rewriting.info<br>|-- symbols.info<br>`-- xattr.h<br></code></pre></td></tr></table></figure> 具体各文件是如何生成的将在<a href="#merger.py-文件">merger.py 文件</a>中具体介绍。</p>
<h4 id="clang-操作静态分析">clang 操作（静态分析）</h4>
<p>类似于<code>cmd_merge_all</code>函数，<code>cmd_clang</code>和<code>cmd_clang_all</code>函数通过调用<code>_run_clang</code>函数进行静态分析。 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_run_clang</span>(<span class="hljs-params">fs, clang</span>):<br>    one_d = join(ROOT, <span class="hljs-string">&quot;out&quot;</span>, fs)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(one_d):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ERROR: %s doesn&#x27;t exist (need to merge first)&quot;</span> % one_d)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    out_d = join(ROOT, <span class="hljs-string">&quot;out&quot;</span>, fs, <span class="hljs-string">&quot;clang-log&quot;</span>)<br><br>    <span class="hljs-comment"># could you tweak this to run clang pass</span><br>    env = copy.copy(os.environ)<br>    env[<span class="hljs-string">&quot;CCC_CC&quot;</span>] = clang<br>    env[<span class="hljs-string">&quot;CLANG&quot;</span>] = clang<br><br>    mkdirp(out_d)<br><br>    clang_result = join(out_d, <span class="hljs-string">&quot;fss_output&quot;</span>)<br>    clang_stdout = <span class="hljs-built_in">open</span>(join(out_d, <span class="hljs-string">&quot;log.stdout&quot;</span>), <span class="hljs-string">&quot;w&quot;</span>)<br>    clang_stderr = <span class="hljs-built_in">open</span>(join(out_d, <span class="hljs-string">&quot;log.stderr&quot;</span>), <span class="hljs-string">&quot;w&quot;</span>)<br><br>    <span class="hljs-keyword">with</span> chdir(one_d):<br>        env[<span class="hljs-string">&quot;PWD&quot;</span>] = os.getcwd()<br>        p = subprocess.Popen([FSCK,<br>                              <span class="hljs-string">&quot;--use-analyzer=%s&quot;</span> % clang,<br>                              <span class="hljs-string">&quot;--fss-output-dir=%s&quot;</span> % clang_result,<br>                              <span class="hljs-string">&quot;make&quot;</span>,<br>                              <span class="hljs-string">&quot;CC=%s&quot;</span> % clang,<br>                              <span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&quot;Makefile.build&quot;</span>],<br>                             stdout=clang_stdout,<br>                             stderr=clang_stderr,<br>                             cwd=os.getcwd(),<br>                             env=env)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[%s] parsing %s&quot;</span> % (p.pid, fs))<br>        p.wait()<br><br>    <span class="hljs-keyword">del</span> clang_stdout<br>    <span class="hljs-keyword">del</span> clang_stderr<br></code></pre></td></tr></table></figure> 当执行<code>./ctrl.py merge ext3</code>时，传递给<code>subprocess.Popen</code>的参数为<code>['/home/juxta/analyzer/../llvm/tools/clang/tools/scan-build/fss-build', '--use-analyzer=/home/juxta/analyzer/../bin/llvm/bin/clang', '--fss-output-dir=/home/juxta/analyzer/out/ext3/clang-log/fss_output', 'make', 'CC=/home/juxta/analyzer/../bin/llvm/bin/clang', '-f', 'Makefile.build']</code>。</p>
<p>相较于merge之后，<code>out/ext3</code>目录下多出来了如下文件。其中<code>log.stdout</code>和<code>log.stderr</code>是Clang的标准输出和标准错误日志。<code>make</code>命令将其以模块的形式编译。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.<br>|-- Module.symvers<br>|-- clang-log<br>|   |-- fss_output<br>|   |   |-- analyzer<br>|   |   |   `-- out<br>|   |   |       `-- ext3<br>|   |   |           |-- ext3.mod.c.fss<br>|   |   |           `-- one.c.fss<br>|   |   |-- clang_output_25P0jk<br>|   |   `-- dev<br>|   |       `-- null.fss<br>|   |-- log.stderr<br>|   `-- log.stdout<br>|-- ext3.ko<br>|-- ext3.mod.c<br>|-- ext3.mod.o<br>|-- ext3.o<br>|-- modules.order<br>`-- one.o<br></code></pre></td></tr></table></figure> 接下来我们将进入<code>analyzer/../llvm/tools/clang/tools/scan-build</code>目录下，来<a href="#fss-build-脚本">深入探究一下<code>fss-build</code>文件做了哪些工作</a>。</p>
<h3 id="merger.py-文件">merger.py 文件</h3>
<h4 id="merge_fs-函数">merge_fs 函数</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># process a fs</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_fs</span>(<span class="hljs-params">opts, fs</span>):<br>    src_d = os.path.join(opts.linux, <span class="hljs-string">&quot;fs&quot;</span>, fs)<br>    dst_d = <span class="hljs-string">&quot;out/%s&quot;</span> % fs<br>    kconf = load_kconfig(os.path.join(opts.linux, <span class="hljs-string">&quot;.config&quot;</span>))<br><br>    (target, files, cflags) = parse_makefile(kconf, src_d)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; fs   : %s&quot;</span> % target)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; files: %s&quot;</span> % files)<br><br>    <span class="hljs-keyword">if</span> fs != target:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;! WARNING: you might not want: %s vs %s?&quot;</span> % (fs, target))<br><br>    <span class="hljs-comment"># adjust path</span><br>    files = adjust_file_path(src_d, files)<br><br>    <span class="hljs-comment"># copy non-c files</span><br>    prepare_dir(fs, opts.linux, src_d, dst_d, cflags)<br><br>    <span class="hljs-comment"># preprocess: opt out headers &amp; expand</span><br>    codes = preprocess(fs, src_d, files)<br><br>    <span class="hljs-comment"># rewrite</span><br>    out = os.path.join(dst_d, <span class="hljs-string">&quot;one.c&quot;</span>)<br>    (out_symbols, out_rewriting) = rewrite(fs, codes, out)<br><br>    <span class="hljs-comment"># kept them for debugging</span><br>    dump_symbols_to_file(dst_d, <span class="hljs-string">&quot;rewriting.info&quot;</span>, out_rewriting)<br>    dump_symbols_to_file(dst_d, <span class="hljs-string">&quot;symbols.info&quot;</span>, out_symbols)<br><br>    <span class="hljs-comment"># final touch</span><br>    post_adjust_per_fs(fs, dst_d, out)<br></code></pre></td></tr></table></figure>
<p><code>adjust_file_path(src_d, files)</code>输入的<code>src_d</code>是Linux某一文件系统的绝对路径，<code>files</code>是该文件系统具体文件，<code>adjust_file_path</code>函数返回相对于当前目录（analyzer）的路径。</p>
<p><code>prepare_dir(fs, opts.linux, src_d, dst_d, cflags)</code>将文件系统下的<code>Kconfig</code>、<code>Makefile</code>、以及<code>.h</code>文件复制到<code>analyzer/out</code>目录对应的文件系统下，并创建用于构建模块的Makefile.build和Makefile（舍弃了之前复制过来的）。</p>
<p>随后将代码合并并写入<code>one.c</code>文件中，每个文件系统都有一个<code>one.c</code>文件。再对预处理后的代码进行重写，将特定符号替换为新的符号，并将重写后的代码写入输出文件。还会返回符号表和重写计划用于调试。</p>
<p>最后注释掉或修复特定文件中的特定代码段。自此就完成了文件系统的合并。</p>
<h4 id="preprocess-函数">preprocess 函数</h4>
<p>preprocess(fs, src_d, files)对某一文件系统下的所有文件进行预处理，包括处理头文件引用和内联C文件，并将处理后的代码存储在一个列表中以供后续使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># opt out headers &amp; expand</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess</span>(<span class="hljs-params">fs, src_d, files</span>):<br>    headers = <span class="hljs-built_in">set</span>()<br>    codes = []<br>    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(f) <span class="hljs-keyword">as</span> fd:<br>            code = []<br>            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> preprocess_headers(fs, src_d, fd.read(), headers):<br>                code.append(l)<br>            code = <span class="hljs-string">&quot;\n&quot;</span>.join(code)<br>            codes.append((f, code))<br><br>    <span class="hljs-keyword">return</span> codes<br></code></pre></td></tr></table></figure>
<h4 id="preprocess_headers-函数">preprocess_headers 函数</h4>
<p><code>preprocess_headers(fs, src_d, code, headers)</code>函数预处理文件系统C代码中的头文件。</p>
<p><code>preprocess_headers</code> 函数接受四个参数：</p>
<ul>
<li><code>fs</code>：表示文件系统的名称。</li>
<li><code>src_d</code>：表示文件系统源代码的目录路径。</li>
<li><code>code</code>：表示要预处理的C代码。</li>
<li><code>headers</code>：表示已经处理过的头文件集合（一个集合数据结构）。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># preprocess headers</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_headers</span>(<span class="hljs-params">fs, src_d, code, headers</span>):<br>    prev_inc = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> code.splitlines():<br>        m = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">&#x27;#[ \t]*include[ \t]*[&lt;&quot;]([^&gt;&quot;]+)[&quot;&gt;]&#x27;</span>, l)<br>        <span class="hljs-keyword">if</span> m:<br>            inc = m.groups()[<span class="hljs-number">0</span>]<br><br>            <span class="hljs-comment"># NOTE. include &quot;.c&quot; (by minix)</span><br>            <span class="hljs-keyword">if</span> inc.endswith(<span class="hljs-string">&#x27;.c&#x27;</span>):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; inlining &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(inc))<br><br>                <span class="hljs-comment"># inlining .c code</span><br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;/* inlined: &quot;</span> + inc + <span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">40</span> + <span class="hljs-string">&quot;/&quot;</span><br>                inlined_code = load_fs_file(fs, os.path.join(src_d, inc))<br>                <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> preprocess_headers(fs, src_d, inlined_code, headers):<br>                    <span class="hljs-keyword">yield</span> l<br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">60</span> + <span class="hljs-string">&quot;/&quot;</span><br><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-comment"># to make sure that header files not duplicated</span><br>            <span class="hljs-keyword">if</span> inc <span class="hljs-keyword">in</span> headers: <br>                l = <span class="hljs-string">&quot;// %s&quot;</span> % l <br>            <span class="hljs-keyword">else</span>:<br>                headers.add(inc)<br>                prev_inc = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> prev_inc:<br>            <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;#include \&quot;../../inc/__fss.h\&quot;&quot;</span><br>            <span class="hljs-keyword">if</span> os.path.exists(os.path.join(ROOT, <span class="hljs-string">&quot;inc&quot;</span>, <span class="hljs-string">&quot;__%s.h&quot;</span> % fs)):    <span class="hljs-comment"># seems never used</span><br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;#include \&quot;../../inc/__%s.h\&quot;&quot;</span> % fs<br>            prev_inc = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">yield</span> l<br></code></pre></td></tr></table></figure>
<p>使用正则表达式 <code>re.match</code> 匹配行中的 <code>#include</code> 语句。如果匹配成功，将头文件路径提取出来，存储在 <code>inc</code> 变量中。 如果头文件路径以 ".c" 结尾，表示要内联这个C文件的代码，然后调用递归函数 <code>preprocess_headers</code> 处理内联的C代码。内联的代码会被注释以标识它们是内联的。这可以用于将某个C文件的内容嵌入到当前C代码中。</p>
<p>如果 <code>inc</code> 在 <code>headers</code> 集合中，表示这个头文件已经被处理过，那么将当前行注释掉。</p>
<p>如果 <code>inc</code> 不在 <code>headers</code> 集合中，表示这个头文件是第一次遇到，将它添加到 <code>headers</code> 集合中，并标记 <code>prev_inc</code> 为 <code>True</code>。 <code>prev_inc</code> 变量用于跟踪前一个行是否是 <code>#include</code> 行，在 <code>#include</code> 代码块结束时添加<code>#include "../../inc/__fss.h"</code>，<code>__fss.h</code>用于代码的调试和错误处理。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// __fss.h</span><br><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ____FSS_H__</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ____FSS_H__</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> BUG</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> BUG_ON</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">BUG</span><span class="hljs-params">()</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUG_ON(condition) do &#123; <span class="hljs-keyword">if</span> (unlikely(condition)) BUG(); &#125; while (0)</span><br><span class="hljs-comment">// while(0) is to make sure the sentence will be executed once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* ____FSS_H__ */</span></span><br><br></code></pre></td></tr></table></figure> 最后，将处理后的代码行逐行 <code>yield</code> 出来，生成器函数返回处理后的C代码。</p>
<h4 id="rewrite-函数">rewrite 函数</h4>
<p><code>rewrite(fs, codes, out)</code>将代码中的特定符号（symbols）替换为新的符号，然后将重写后的代码写入输出文件。</p>
<p>首先利用<code>prepare_rewritting</code>函数生成重写计划。</p>
<p><code>rewritten = highlight(code, CLexer(), TokenRewritter(pn, rewriting_plan))</code>这一行代码用于重写代码。它执行以下操作：</p>
<ul>
<li>使用 <code>CLexer()</code> 创建一个C语言的词法分析器，用于将代码拆分为 tokens。</li>
<li>创建一个 <code>TokenRewritter</code> 对象，传递文件名 <code>pn</code>(path name的缩写，实际上为文件路径) 和重写计划 <code>rewriting_plan</code>，以便在词法分析期间替换符号。</li>
<li>调用 <code>highlight</code> 函数，将 <code>code</code> 传递给它，同时传递词法分析器和重写器对象，以执行重写操作。重写后的代码存储在 <code>rewritten</code> 变量中。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># rewrite codes and flush them to out</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rewrite</span>(<span class="hljs-params">fs, codes, out</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> fd:<br>        (static_symbols, rewriting_plan) = prepare_rewritting(fs, codes)<br>        <span class="hljs-keyword">for</span> (pn, code) <span class="hljs-keyword">in</span> codes:<br>            <span class="hljs-comment"># reschedule static symbols</span><br>            rewritten = highlight(code, CLexer(), TokenRewritter(pn, rewriting_plan))<br>            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> rewritten.splitlines():<br>                fd.write(l.encode(<span class="hljs-string">&quot;utf8&quot;</span>))<br>                fd.write(<span class="hljs-string">&quot;\n&quot;</span>)<br><br>            fd.write(<span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;*&quot;</span> * <span class="hljs-number">60</span> + <span class="hljs-string">&quot;/\n&quot;</span>)<br>            fd.write(<span class="hljs-string">&quot;/* %s */\n&quot;</span> % pn)<br>            fd.write(<span class="hljs-string">&quot;/&quot;</span> + <span class="hljs-string">&quot;*&quot;</span> * <span class="hljs-number">60</span> + <span class="hljs-string">&quot;/\n&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> (static_symbols, rewriting_plan)<br></code></pre></td></tr></table></figure>
<h4 id="prepare_rewritting-函数">prepare_rewritting 函数</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># manual opt out</span><br><span class="hljs-comment">#  (see, logfs defines hash_32() which was included by other c files)</span><br><span class="hljs-keyword">global</span> FS_FORCE_REWRITE<br>FS_FORCE_REWRITE = &#123;<br>    <span class="hljs-string">&quot;logfs&quot;</span>: [<span class="hljs-string">&quot;hash_32&quot;</span>],<br>    <span class="hljs-string">&quot;minix&quot;</span>: [<span class="hljs-string">&quot;DIRECT&quot;</span>, <span class="hljs-string">&quot;DEPTH&quot;</span>, <span class="hljs-string">&quot;block_t&quot;</span>, <span class="hljs-string">&quot;Indirect&quot;</span>, <span class="hljs-string">&quot;pointers_lock&quot;</span>, <span class="hljs-string">&quot;block_to_cpu&quot;</span>],<br>    <span class="hljs-string">&quot;ncpfs&quot;</span>: [<span class="hljs-string">&quot;ncp_symlink&quot;</span>, <span class="hljs-string">&quot;ncp_symlink_readpage&quot;</span>],<br>    <span class="hljs-string">&quot;jffs2&quot;</span>: [<span class="hljs-string">&quot;deflate_mutex&quot;</span>],<br>    <span class="hljs-string">&quot;nfsd&quot;</span> : [<span class="hljs-string">&quot;NFSDDBG_FACILITY&quot;</span>, <span class="hljs-string">&quot;nfs3_ftypes&quot;</span>],<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>FS_FORCE_REWRITE</code> 是一个字典，它的键是文件系统的名称，值是需要手动进行符号替换的符号列表。</p>
<p>例如<code>nfs3_ftypes</code>，既存在于<code>nfsd/nfs3xdr.c</code>中，又存在于<code>nfsd/nfs3proc.c</code>中，合并文件后会导致函数重复定义的错误，所以需要手动替换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># parse and prepare conflicted symbols</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_rewritting</span>(<span class="hljs-params">target, codes</span>):<br>    <span class="hljs-keyword">global</span> FS_FORCE_REWRITE<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_to_canonical</span>(<span class="hljs-params">pn, sym</span>):<br>        base = os.path.basename(pn)<br>        <span class="hljs-keyword">return</span> sym + <span class="hljs-string">&quot;_&quot;</span> + base.replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>)<br><br>    <span class="hljs-comment"># get static symbols</span><br>    static_symbols = &#123;&#125;<br>    <span class="hljs-keyword">for</span> (pn, code) <span class="hljs-keyword">in</span> codes:<br>        formatter= StaticDecl()<br>        highlight(code, CLexer(), formatter)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; %-50s: %d&quot;</span> % (pn, <span class="hljs-built_in">len</span>(formatter.table)))<br>        static_symbols[pn] = formatter.table<br><br>    <span class="hljs-comment"># check collisions</span><br>    rewriting_plan = defaultdict(<span class="hljs-built_in">dict</span>)<br>    <span class="hljs-keyword">for</span> (pivot_pn, pivot_tbl) <span class="hljs-keyword">in</span> static_symbols.iteritems():<br>        <span class="hljs-comment"># rewrite if collapsed</span><br>        <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> pivot_tbl:<br>            <span class="hljs-keyword">for</span> (target_pn, target_tbl) <span class="hljs-keyword">in</span> static_symbols.iteritems():<br>                <span class="hljs-keyword">if</span> pivot_pn == target_pn:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">if</span> sym <span class="hljs-keyword">in</span> target_tbl:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; %s collaposed with %s &amp; %s&quot;</span> % (sym, pivot_pn, target_pn))<br>                    rewriting_plan[pivot_pn][sym] = _to_canonical(pivot_pn, sym)<br><br>        <span class="hljs-comment"># update pivot_tbl to minize rewriting</span><br>        <span class="hljs-keyword">for</span> (sym, new_sym) <span class="hljs-keyword">in</span> rewriting_plan[pivot_pn].iteritems():<br>            pivot_tbl.remove(sym)<br>            pivot_tbl.add(new_sym)<br><br>    <span class="hljs-comment"># manual rewriting (e.g., collision in headers)</span><br>    <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> FS_FORCE_REWRITE.get(target, []):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; manually include %s&quot;</span> % sym)<br>        <span class="hljs-keyword">for</span> (pivot_pn, pivot_tbl) <span class="hljs-keyword">in</span> static_symbols.iteritems():<br>            rewriting_plan[pivot_pn][sym] = _to_canonical(pivot_pn, sym)<br><br>    <span class="hljs-keyword">return</span> (static_symbols, rewriting_plan)<br></code></pre></td></tr></table></figure>
<p>首先先通过名为<code>formatter</code>的<code>StaticDecl</code>对象，使用<code>highlight</code>函数，<code>CLexer()</code>词法分析器和<code>formatter</code>来解析代码，获取<code>static symbols</code>。</p>
<p><code>static symbols</code>的格式如下所示： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&#123;&#x27;../../linux/fs/minix/namei.c&#x27;: set([u&#x27;minix_create&#x27;, u&#x27;minix_rename&#x27;, u&#x27;minix_unlink&#x27;, u&#x27;add_nondir&#x27;, u&#x27;minix_mknod&#x27;, u&#x27;minix_lookup&#x27;, u&#x27;minix_link&#x27;, u&#x27;minix_mkdir&#x27;, u&#x27;minix_rmdir&#x27;, u&#x27;minix_tmpfile&#x27;, u&#x27;minix_symlink&#x27;]), <br>&#x27;../../linux/fs/minix/inode.c&#x27;: set([u&#x27;V2_minix_iget&#x27;, u&#x27;minix_destroy_inode&#x27;, u&#x27;minix_fill_super&#x27;, u&#x27;minix_writepage&#x27;, u&#x27;exit_minix_fs&#x27;, u&#x27;minix_write_inode&#x27;, u&#x27;minix_remount&#x27;, u&#x27;minix_evict_inode&#x27;, u&#x27;minix_get_block&#x27;, u&#x27;destroy_inodecache&#x27;, u&#x27;minix_i_callback&#x27;, u&#x27;minix_mount&#x27;, u&#x27;minix_write_failed&#x27;, u&#x27;minix_bmap&#x27;, u&#x27;minix_alloc_inode&#x27;, u&#x27;minix_statfs&#x27;, u&#x27;V1_minix_iget&#x27;, u&#x27;init_once&#x27;, u&#x27;init_inodecache&#x27;, u&#x27;minix_readpage&#x27;, u&#x27;minix_put_super&#x27;, u&#x27;minix_write_begin&#x27;, u&#x27;init_minix_fs&#x27;]), <br>...&#125;<br></code></pre></td></tr></table></figure></p>
<p>随后创建<code>rewriting_plan</code>字典，用于存储重写计划。它将跟踪哪些符号需要进行重写，以解决符号冲突问题。</p>
<p>20-33行检查符号冲突和生成重写计划。外部循环遍历<code>static_symbols</code>字典的键值对，其中<code>pivot_pn</code>是文件名，<code>pivot_tbl</code>是该文件的静态符号表。 内部循环遍历同样的<code>static_symbols</code>字典，但排除了与外部文件名相同的文件。如果在不同文件中的找到相同的符号，会调用<code>_to_canonical</code>函数，更新外部循环对应文件的符号重写计划。<code>_to_canonical(pn, sym)</code>是一个内部辅助函数，为符号 <code>sym</code> 生成一个新的规范名称，以确保符号的唯一性。一个文件的符号重写计划处理完之后（第二个<code>for</code>循环执行结束后）会更新该文件的符号表为重写后的符号，以最小化重写。</p>
<p>36-39行制作<code>FS_FORCE_REWRITE</code>中符号的重写计划。</p>
<p>最后，函数返回一个包含两个元素的元组，第一个元素是新的<code>static_symbols</code>字典，第二个元素是静态符号的<code>rewriting_plan</code>字典。</p>
<h4 id="staticdecl-类">StaticDecl 类</h4>
<p><code>Token.Comment.Preproc</code>（预处理器注释令牌）是指用于表示预处理器指令或注释的特殊类型的标记（Token）。在 C 语言中常见的可标注为<code>Token.Comment.Preproc</code>的例子如下：</p>
<ol type="1">
<li>条件编译指令： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> DEBUG</span><br>    <span class="hljs-comment">// 这是一个调试模式下的代码块</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li>
<li>宏定义： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_SIZE 100</span><br></code></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticDecl</span>(<span class="hljs-title class_ inherited__">Formatter</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.table = <span class="hljs-built_in">set</span>()<br>        <span class="hljs-comment"># NOTE. nothing yet</span><br>        self.blacklist = <span class="hljs-built_in">set</span>([<span class="hljs-string">&quot;nfsd3_voidargs&quot;</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_dot_tok</span>(<span class="hljs-params">self, token, value</span>):     <span class="hljs-comment"># it seems never used</span><br>        <span class="hljs-keyword">return</span> token <span class="hljs-keyword">is</span> Token.Punctuation <span class="hljs-keyword">and</span> value == <span class="hljs-string">&quot;.&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">self, tokensource, outfile</span>): <span class="hljs-comment"># outfile never used</span><br>        lookup = []<br>        <span class="hljs-keyword">for</span> ttype, value <span class="hljs-keyword">in</span> tokensource:<br>            <span class="hljs-comment"># strong blacklisting</span><br>            <span class="hljs-keyword">if</span> value <span class="hljs-keyword">in</span> self.blacklist:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">if</span> ttype <span class="hljs-keyword">is</span> Token.Name.Function:<br>                <span class="hljs-comment"># e.g., DEFINE_SPINLOCK() or DEFINE_RWLOCK()</span><br>                <span class="hljs-keyword">if</span> value.startswith(<span class="hljs-string">&quot;DEFINE_&quot;</span>) \<br>                   <span class="hljs-keyword">or</span> value.startswith(<span class="hljs-string">&quot;LIST_HEAD&quot;</span>) \<br>                   <span class="hljs-keyword">or</span> value.startswith(<span class="hljs-string">&quot;LLIST_HEAD&quot;</span>) \<br>                   <span class="hljs-keyword">or</span> value.startswith(<span class="hljs-string">&quot;DECLARE_DELAYED_WORK&quot;</span>):<br>                    <span class="hljs-keyword">continue</span><br><br>                <span class="hljs-comment"># NOTE. arbitrary tokens can be inserted before static</span><br>                <span class="hljs-comment"># shows up, but usually 5.</span><br>                is_static = <span class="hljs-literal">False</span>   <span class="hljs-comment"># never used</span><br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>                    <span class="hljs-keyword">if</span> lookup[-i][<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> Token.Keyword \<br>                       <span class="hljs-keyword">and</span> lookup[-i][<span class="hljs-number">1</span>] == <span class="hljs-string">&quot;static&quot;</span>:<br>                        self.table.add(value)<br>                        <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> ttype <span class="hljs-keyword">is</span> Token.Punctuation <span class="hljs-keyword">and</span> value == <span class="hljs-string">&quot;&#123;&quot;</span>:<br>                struct_name = <span class="hljs-literal">None</span><br>                struct_keyword = <span class="hljs-literal">None</span><br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>                    (typ, val) = lookup[-i]<br>                    <span class="hljs-keyword">if</span> typ <span class="hljs-keyword">is</span> Token.Keyword <span class="hljs-keyword">and</span> val == <span class="hljs-string">&quot;struct&quot;</span>:<br>                        struct_keyword = <span class="hljs-literal">True</span><br>                        <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">if</span> typ <span class="hljs-keyword">is</span> Token.Name <span class="hljs-keyword">and</span> struct_keyword <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                        struct_name = val<br><br>                <span class="hljs-keyword">if</span> struct_keyword <span class="hljs-keyword">and</span> struct_name:<br>                    self.table.add(struct_name)<br><br>            lookup.append((ttype, value))<br></code></pre></td></tr></table></figure>
<p>16 - 31 行的目的是为了找出所有的静态函数并将函数名添加到<code>self.table</code>中（除去函数名开头为<code>DEFINE_</code>、<code>LIST_HEAD</code>、<code>LLIST_HEAD</code>、<code>DECLARE_DELAYED_WORK</code>的函数）。</p>
<p>32 - 44 行的目的是为了找出所有的结构体并将结构体名添加到<code>self.table</code>中。</p>
<p><code>self.table</code>中存储的即为static symbols。</p>
<p>最后一行<code>lookup.append((ttype, value))</code>跳过了<code>self.blacklist</code>（不包括预处理指令中的，预处理指令中的格式是<code>Token.Comment.Preproc, u'define nfsd3_voidres\t\t\tnfsd3_voidargs'</code>，没有单独的<code>nfsd3_voidargs</code>）和函数名开头为<code>DEFINE_</code>、<code>LIST_HEAD</code>、<code>LLIST_HEAD</code>、<code>DECLARE_DELAYED_WORK</code>的函数。</p>
<h4 id="tokenrewritter-类">TokenRewritter 类</h4>
<p><code>TokenRewritter</code>是一个自定义的Pygments格式化器类，它继承自Pygments中的 <code>Formatter</code> 类。这个类的主要目的是在代码高亮和着色的过程中，根据预定的重写计划对特定符号进行替换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenRewritter</span>(<span class="hljs-title class_ inherited__">Formatter</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, pn, plan</span>):<br>        self.pn = pn<br>        self.plan = plan<br>        self.syms = plan[pn]<br>        self.stat = Counter()<br>        self.lookup = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_dot_tok</span>(<span class="hljs-params">self, token, value</span>):<br>        <span class="hljs-keyword">return</span> token <span class="hljs-keyword">is</span> Token.Punctuation <span class="hljs-keyword">and</span> value == <span class="hljs-string">&quot;.&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">self, tokensource, outfile</span>):<br>        lookup = []<br>        <span class="hljs-keyword">for</span> ttype, value <span class="hljs-keyword">in</span> tokensource:<br>            <span class="hljs-comment"># tokens used in macro</span><br>            <span class="hljs-keyword">if</span> ttype <span class="hljs-keyword">is</span> Token.Comment.Preproc:<br>                <span class="hljs-keyword">for</span> (k, v) <span class="hljs-keyword">in</span> self.syms.iteritems():<br>                    <span class="hljs-keyword">if</span> k <span class="hljs-keyword">in</span> value:<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; rewrite (mcro) %s -&gt; %s&quot;</span> % (k, v))<br>                        value = value.replace(k, v)<br>                        self.stat[value] += <span class="hljs-number">1</span><br>            <span class="hljs-comment"># check regular function call</span><br>            <span class="hljs-keyword">if</span> ttype <span class="hljs-keyword">is</span> Token.Name \<br>                    <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.is_dot_tok(*lookup[-<span class="hljs-number">1</span>]):<br>                <span class="hljs-comment">#</span><br>                <span class="hljs-comment"># NOTE (ignore, wrong pygment parser)</span><br>                <span class="hljs-comment">#   struct.func_ptr =&gt; [Token.Punctuation][Toen.Name]</span><br>                <span class="hljs-comment">#</span><br>                new_sym = self.syms.get(value, <span class="hljs-literal">None</span>)<br>                <span class="hljs-keyword">if</span> new_sym:<br>                    self.stat[value] += <span class="hljs-number">1</span><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; rewrite (call) %s -&gt; %s&quot;</span> % (value, new_sym))<br>                    value = new_sym<br><br>            <span class="hljs-comment"># check func decls</span><br>            <span class="hljs-keyword">if</span> ttype <span class="hljs-keyword">is</span> Token.Name.Function <span class="hljs-keyword">or</span> ttype <span class="hljs-keyword">is</span> Token.Keyword.<span class="hljs-type">Type</span>:<br>                new_sym = self.syms.get(value, <span class="hljs-literal">None</span>)<br>                <span class="hljs-keyword">if</span> new_sym:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; rewrite (decl) %s -&gt; %s&quot;</span> % (value, new_sym))<br>                    value = new_sym<br><br>            lookup.append((ttype, value))<br><br>            outfile.write(value)<br>            lookup.append((ttype, value))<br></code></pre></td></tr></table></figure>
<p><code>pn</code>表示当前处理的文件名（包含路径）。</p>
<p><code>plan</code>表示重写计划，一个字典，包含了要替换的符号对应关系，将旧的标识符映射到新的标识符或宏定义。</p>
<p><code>self.stat</code> 是一个 <code>Counter</code> 对象，用于跟踪替换操作的统计信息。</p>
<p><code>self.lookup</code> 是一个空列表，用于存储遍历Token时的历史信息。</p>
<h3 id="clang-相关代码解析">Clang 相关代码解析</h3>
<p>Juxta 所用 Clang 为修改后的版本，其之间的差别见 <a target="_blank" rel="noopener" href="https://github.com/jtzhpf/llvm-project-juxta-sosp/blob/juxta-sosp/README.md">https://github.com/jtzhpf/llvm-project-juxta-sosp/blob/juxta-sosp/README.md</a>。</p>
<h4 id="options.td-文件">Options.td 文件</h4>
<p><code>./llvm/tools/clang/include/clang/Driver/Options.td</code> 文件定义了clang编译器支持的所有命令行选项。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs TableGen">def ffs_semantic_out_dir_EQ : Joined&lt;[&quot;-&quot;], &quot;ffs-semantic-out-dir=&quot;&gt;,<br>    Group&lt;f_Group&gt;, Flags&lt;[DriverOption, CC1Option]&gt;,<br>    HelpText&lt;&quot;Output directory of fs semantics analysis&quot;&gt;;	<br>def ffs_semantic_EQ : Joined&lt;[&quot;-&quot;], &quot;ffs-semantic=&quot;&gt;,<br>    Group&lt;f_Group&gt;, Flags&lt;[DriverOption, CC1Option]&gt;,<br>    HelpText&lt;&quot;Enable fs semantics analysis&quot;&gt;;	<br></code></pre></td></tr></table></figure>
<p><code>Options.td</code> 文件新增了上面的代码，这两个选项 <code>ffs_semantic_out_dir_EQ</code> 和 <code>ffs_semantic_EQ</code> 是 Clang 编译器的命令行选项，用于控制文件系统语义分析（Filesystem Semantics Analysis）的行为。下面是对这两个选项的详细解释：</p>
<ol type="1">
<li><code>ffs_semantic_out_dir_EQ</code> 选项：
<ul>
<li><code>ffs_semantic_out_dir_EQ</code> 是一个带有参数的选项，它的形式是 <code>-ffs-semantic-out-dir=&lt;directory&gt;</code>。</li>
<li><code>&lt;directory&gt;</code> 是用户提供的路径，用于指定文件系统语义分析的输出目录。</li>
<li>这个选项属于 <code>f_Group</code> 组，表示它与 <code>-f</code> 开头的选项相关联。</li>
<li>该选项被标记为 <code>DriverOption</code> 和 <code>CC1Option</code>，表示它既可以在编译器驱动程序中使用，也可以在 Clang 的前端（<code>-cc1</code>）中使用。</li>
<li><code>HelpText</code> 字段提供了对该选项用途的描述，它说明了该选项用于指定文件系统语义分析的输出目录。</li>
</ul></li>
<li><code>ffs_semantic_EQ</code> 选项：
<ul>
<li><code>ffs_semantic_EQ</code> 也是一个带有参数的选项，它的形式是 <code>-ffs-semantic=&lt;value&gt;</code>。</li>
<li><code>&lt;value&gt;</code> 是用户提供的值，用于启用或禁用文件系统语义分析。</li>
<li>这个选项同样属于 <code>f_Group</code> 组，表示它与 <code>-f</code> 开头的选项相关联。</li>
<li>类似地，该选项也被标记为 <code>DriverOption</code> 和 <code>CC1Option</code>，表示它可以在编译器驱动程序中和 Clang 前端中使用。</li>
<li><code>HelpText</code> 字段提供了对该选项用途的描述，它说明了该选项用于启用或禁用文件系统语义分析。</li>
</ul></li>
</ol>
<p>这两个选项通常用于控制编译器在进行文件系统操作时的语义分析行为。用户可以使用 <code>ffs_semantic_out_dir_EQ</code> 选项来指定分析结果的输出目录，同时使用 <code>ffs_semantic_EQ</code> 选项来启用或禁用文件系统语义分析。</p>
<!--
#### ProgramState.h 文件
`./llvm/tools/clang/include/clang/StaticAnalyzer/Core/PathSensitive/ProgramState.h` 头文件用于clang静态分析器中的路径敏感状态跟踪。

主要功能包括：
- 定义了ProgramState类，用于表示分析中的程序状态。包括环境映射(Env)、存储映射(Store)、泛型数据映射(GDM)等，可以绑定值到语句和位置等。
- 定义了ProgramStateManager类，用于管理ProgramState对象的工厂。提供创建、重用ProgramState的方法。
- 定义了各种遍历ProgramState历史的迭代器。
- 提供了访问和操作ProgramState中环境、存储、泛型数据映射等的方法。
- 提供了各种"assume"方法，在ProgramState上添加约束。
- 一些辅助类，如ScanReachableSymbols用于访问可达符号。
- ProgramStateTrait类模板，用于泛型数据映射中类型安全的访问。
- HistoricalEvent类，记录ProgramState变化事件。
-->
<h4 id="fss-build-脚本">fss-build 脚本</h4>
<p><code>fss-build</code> 是一个 Perl 脚本，位于<code>./llvm/tools/clang/tools/scan-build/fss-build</code>，用于在构建过程中运行 Clang 静态分析工具。<code>fss-build</code> 是在 <code>scan-build</code> 的基础上修改而来，在这里我们只用到了其中的部分功能。</p>
<p>主要流程:</p>
<ol type="1">
<li>解析命令行选项，包括启用/禁用检查器、输出目录等。</li>
<li>设置环境变量，将 <code>CC</code> 和 <code>CXX</code> 重定向到 <a href="#fssccc-analyzer-与-fssc-analyzer-脚本"><code>fssccc-analyzer</code> 和 <code>fssc++-analyzer</code> wrapper 脚本</a>。</li>
<li>调用构建命令，如 <code>make</code>、<code>xcodebuild</code> 等，在构建过程中运行静态分析。</li>
<li>收集并处理分析结果。</li>
</ol>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">RunBuildCommand</span> </span>&#123;<br>  <span class="hljs-keyword">my</span> $Args = <span class="hljs-keyword">shift</span>;<br>  <span class="hljs-keyword">my</span> $IgnoreErrors = <span class="hljs-keyword">shift</span>;<br>  <span class="hljs-keyword">my</span> $Cmd = $Args-&gt;[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">my</span> $CCAnalyzer = <span class="hljs-keyword">shift</span>;<br>  <span class="hljs-keyword">my</span> $CXXAnalyzer = <span class="hljs-keyword">shift</span>;<br>  <span class="hljs-keyword">my</span> $Options = <span class="hljs-keyword">shift</span>;<br><br>  <span class="hljs-keyword">if</span> ($Cmd =~ <span class="hljs-regexp">/\bxcodebuild$/</span>) &#123;<br>    <span class="hljs-keyword">return</span> RunXcodebuild($Args, $IgnoreErrors, $CCAnalyzer, $CXXAnalyzer, $Options);<br>  &#125;<br><br>  <span class="hljs-comment"># Setup the environment.</span><br>  SetEnv($Options);<br><br>  <span class="hljs-keyword">if</span> ($Cmd =~ <span class="hljs-regexp">/(.*\/?gcc[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>      $Cmd =~ <span class="hljs-regexp">/(.*\/?cc[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>      $Cmd =~ <span class="hljs-regexp">/(.*\/?llvm-gcc[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>      $Cmd =~ <span class="hljs-regexp">/(.*\/?clang$)/</span> <span class="hljs-keyword">or</span><br>      $Cmd =~ <span class="hljs-regexp">/(.*\/?fssccc-analyzer[^\/]*$)/</span>) &#123;<br><br>    <span class="hljs-keyword">if</span> (!($Cmd =~ <span class="hljs-regexp">/fssccc-analyzer/</span>) <span class="hljs-keyword">and</span> !<span class="hljs-keyword">defined</span> $ENV&#123;<span class="hljs-string">&quot;CCC_CC&quot;</span>&#125;) &#123;<br>      $ENV&#123;<span class="hljs-string">&quot;CCC_CC&quot;</span>&#125; = $1;<br>    &#125;<br><br>    <span class="hljs-keyword">shift</span> @$Args;<br>    <span class="hljs-keyword">unshift</span> @$Args, $CCAnalyzer;<br>  &#125;<br>  <span class="hljs-keyword">elsif</span> ($Cmd =~ <span class="hljs-regexp">/(.*\/?g\+\+[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>        $Cmd =~ <span class="hljs-regexp">/(.*\/?c\+\+[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>        $Cmd =~ <span class="hljs-regexp">/(.*\/?llvm-g\+\+[^\/]*$)/</span> <span class="hljs-keyword">or</span><br>        $Cmd =~ <span class="hljs-regexp">/(.*\/?clang\+\+$)/</span> <span class="hljs-keyword">or</span><br>        $Cmd =~ <span class="hljs-regexp">/(.*\/?fssc\+\+-analyzer[^\/]*$)/</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!($Cmd =~ <span class="hljs-regexp">/fssc\+\+-analyzer/</span>) <span class="hljs-keyword">and</span> !<span class="hljs-keyword">defined</span> $ENV&#123;<span class="hljs-string">&quot;CCC_CXX&quot;</span>&#125;) &#123;<br>      $ENV&#123;<span class="hljs-string">&quot;CCC_CXX&quot;</span>&#125; = $1;<br>    &#125;<br>    <span class="hljs-keyword">shift</span> @$Args;<br>    <span class="hljs-keyword">unshift</span> @$Args, $CXXAnalyzer;<br>  &#125;<br>  <span class="hljs-keyword">elsif</span> ($Cmd eq <span class="hljs-string">&quot;make&quot;</span> <span class="hljs-keyword">or</span> $Cmd eq <span class="hljs-string">&quot;gmake&quot;</span> <span class="hljs-keyword">or</span> $Cmd eq <span class="hljs-string">&quot;mingw32-make&quot;</span>) &#123;<br>    AddIfNotPresent($Args, <span class="hljs-string">&quot;CC=$CCAnalyzer&quot;</span>);<br>    AddIfNotPresent($Args, <span class="hljs-string">&quot;CXX=$CXXAnalyzer&quot;</span>);<br>    <span class="hljs-keyword">if</span> ($IgnoreErrors) &#123;<br>      AddIfNotPresent($Args,<span class="hljs-string">&quot;-k&quot;</span>);<br>      AddIfNotPresent($Args,<span class="hljs-string">&quot;-i&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">system</span>(@$Args) &gt;&gt; <span class="hljs-number">8</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>重点在<code>RunBuildCommand</code>函数，这个函数将 <code>CC</code> 和 <code>CXX</code> 重定向到 <a href="#fssccc-analyzer-与-fssc-analyzer-脚本"><code>fssccc-analyzer</code> 和 <code>fssc++-analyzer</code></a>，并通过执行<code>system(@$Args)</code>来运行静态分析，其中<code>$Args</code>的内容为 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make CC=/home/juxta/analyzer/../bin/llvm/bin/clang -f Makefile.build CC=/home/juxta/llvm/tools/clang/tools/scan-build/fssccc-analyzer CXX=/home/juxta/llvm/tools/clang/tools/scan-build/fssc++-analyzer<br></code></pre></td></tr></table></figure> 此时的工作目录为<code>./analyzer/out/具体文件系统目录</code>。</p>
<h4 id="fssccc-analyzer-与-fssc-analyzer-脚本">fssccc-analyzer 与 fssc++-analyzer 脚本</h4>
<p><code>fssccc-analyzer</code> 脚本位于 <code>./llvm/tools/clang/tools/scan-build/fssccc-analyzer</code>，<code>fssccc-analyzer</code>的主要执行流程如下：</p>
<blockquote>
<p>1 获取编译命令行参数，分析出编译选项、链接选项和输入文件<br />
2 调用系统的编译器/链接器执行编译/链接<br />
3 对每个输入文件:<br />
</p>
<blockquote>
<p>3.1 判断文件语言类型<br />
3.2 构建调用Clang的命令行，包含静态分析选项<br />
3.3 调用Clang进行编译+分析<br />
3.4 如果Clang发生崩溃或错误，保存相关文件用于调试<br />
3.5 提取Clang分析结果到单独的.fss文件<br />
</p>
</blockquote>
<p>4 如果设置了输出目录，将Clang分析结果保存到该目录<br />
5 根据环境变量设置verbose模式，输出执行过程信息<br />
6 返回系统编译器/链接器的返回值</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">GetCCArgs</span> </span>&#123;<br>  <span class="hljs-keyword">my</span> $mode = <span class="hljs-keyword">shift</span>;<br>  <span class="hljs-keyword">my</span> $Args = <span class="hljs-keyword">shift</span>;<br><br>  <span class="hljs-keyword">pipe</span> (FROM_CHILD, TO_PARENT);<br>  <span class="hljs-keyword">my</span> $pid = <span class="hljs-keyword">fork</span>();<br>  <span class="hljs-keyword">if</span> ($pid == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">close</span> FROM_CHILD;<br>    <span class="hljs-keyword">open</span>(STDOUT,<span class="hljs-string">&quot;&gt;&amp;&quot;</span>, \*TO_PARENT);<br>    <span class="hljs-keyword">open</span>(STDERR,<span class="hljs-string">&quot;&gt;&amp;&quot;</span>, \*TO_PARENT);<br>    <span class="hljs-keyword">exec</span> $Clang, <span class="hljs-string">&quot;-###&quot;</span>, $mode, @$Args;<br>  &#125;<br>  <span class="hljs-keyword">close</span>(TO_PARENT);<br>  <span class="hljs-keyword">my</span> $line;<br>  <span class="hljs-keyword">while</span> (&lt;FROM_CHILD&gt;) &#123;<br>    <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/\s&quot;?-cc1&quot;?\s/</span>);<br>    $line = $_;<br>  &#125;<br><br>  <span class="hljs-keyword">waitpid</span>($pid,<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">close</span>(FROM_CHILD);<br><br>  <span class="hljs-keyword">die</span> <span class="hljs-string">&quot;could not find clang line\n&quot;</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">defined</span> $line);<br>  <span class="hljs-comment"># Strip leading and trailing whitespace characters.</span><br>  $line =~ <span class="hljs-regexp">s/^\s+|\s+$//g</span>;<br>  <span class="hljs-keyword">my</span> @items = quotewords(<span class="hljs-string">&#x27;\s+&#x27;</span>, <span class="hljs-number">0</span>, $line);<br>  <span class="hljs-keyword">my</span> $cmd = <span class="hljs-keyword">shift</span> @items;<br>  <span class="hljs-keyword">die</span> <span class="hljs-string">&quot;cannot find &#x27;clang&#x27; in &#x27;clang&#x27; command\n&quot;</span> <span class="hljs-keyword">if</span> (!($cmd =~ <span class="hljs-regexp">/clang/</span>));<br>  <span class="hljs-keyword">return</span> \@items;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>GetCCArgs</code> 函数用于获取编译器<strong>实际</strong>执行的命令行参数。该函数创建了一个子进程，在子进程中执行<code>$Clang -### $mode @$Args</code>命令。</p>
<blockquote>
<p><code>-###</code> 是作为命令行参数传递给 <code>$Clang</code> 的一个选项。这个选项在 Clang 中具有特殊的含义，它并不是常见的编译或链接选项，而是用于显示编译过程中的详细信息的一种特殊模式。</p>
<p>具体来说，<code>-###</code> 在 Clang 中的作用是：</p>
<ol type="1">
<li><strong>显示编译过程</strong>：当你将 <code>-###</code> 选项传递给 Clang 时，它不会实际执行编译操作，而是会将编译过程的详细信息输出到标准错误（stderr）。这包括了 Clang 执行的实际命令以及每个命令的参数。</li>
<li><strong>调试和诊断</strong>：<code>-###</code> 通常用于调试和诊断构建过程。通过查看输出，开发人员可以了解 Clang 在执行编译操作时究竟执行了哪些命令，以及这些命令使用了哪些参数。这有助于识别构建问题和调试构建系统的配置。</li>
</ol>
<p><strong>示例：</strong> 假设你有一个名为 <code>example.c</code> 的源代码文件，并且你希望查看 Clang 编译该文件时实际执行的命令，你可以运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt;clang -<span class="hljs-comment">### example.c</span><br></code></pre></td></tr></table></figure>
<p>这将导致 Clang 输出类似以下内容的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt;clang version X.X.X (...)<br>&gt;Target: ...<br>&gt;Thread model: ...<br>&gt;InstalledDir: ...<br>&quot;/path/to/clang&quot; -cc1 -triple ... -emit-obj -mrelax-all ...<br></code></pre></td></tr></table></figure>
<p>这些输出中包括了 Clang 执行的实际命令和参数，以及编译器版本信息等。</p>
</blockquote>
<p>子进程的标准输出流和错误流都重定向到管道上，被父进程读取，父进程通过查找包含<code>-cc1</code>的行，即为所需要的<strong>实际</strong>执行的命令行参数，最后使用<code>quotewords</code>函数将命令行分解为单词并返回。</p>
<p>随后进过一系列的命令行参数处理之后，调用<code>Analyze</code>函数。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs perl">Analyze($Clang, \@CmdArgs, \@AnalyzeArgs, $FileLang, $Output, $Verbose, $HtmlDir, $file);<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">Analyze</span> </span>&#123;<br>  <span class="hljs-keyword">my</span> ($Clang, $OriginalArgs, $AnalyzeArgs, $Lang, $Output, $Verbose, $HtmlDir,<br>      $file) = @_;<br><br>  <span class="hljs-keyword">my</span> @Args = @$OriginalArgs;<br>  <span class="hljs-keyword">my</span> $Cmd;<br>  <span class="hljs-keyword">my</span> @CmdArgs;<br>  <span class="hljs-keyword">my</span> @CmdArgsSansAnalyses;<br><br>  <span class="hljs-keyword">if</span> ($Lang =~ <span class="hljs-regexp">/header/</span>) &#123;  <span class="hljs-comment"># not used</span><br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">defined</span> ($Output));<br>    $Cmd = <span class="hljs-string">&#x27;cp&#x27;</span>;<br>    <span class="hljs-keyword">push</span> @CmdArgs, $file;<br>    <span class="hljs-comment"># Remove the PCH extension.</span><br>    $Output =~ <span class="hljs-regexp">s/[.]gch$//</span>;<br>    <span class="hljs-keyword">push</span> @CmdArgs, $Output;<br>    @CmdArgsSansAnalyses = @CmdArgs;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    $Cmd = $Clang;<br><br>    <span class="hljs-comment"># Create arguments for doing regular parsing.</span><br>    <span class="hljs-keyword">my</span> $SyntaxArgs = GetCCArgs(<span class="hljs-string">&quot;-fsyntax-only&quot;</span>, \@Args);<br>    @CmdArgsSansAnalyses = @$SyntaxArgs;<br><br>    <span class="hljs-comment"># Create arguments for doing static analysis.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">defined</span> $ResultFile) &#123;<br>      <span class="hljs-keyword">push</span> @Args, <span class="hljs-string">&#x27;-o&#x27;</span>, $ResultFile;<br>    &#125;<br>    <span class="hljs-keyword">elsif</span> (<span class="hljs-keyword">defined</span> $HtmlDir) &#123;<br>      <span class="hljs-keyword">push</span> @Args, <span class="hljs-string">&#x27;-o&#x27;</span>, $HtmlDir;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ($Verbose) &#123;<br>      <span class="hljs-keyword">push</span> @Args, <span class="hljs-string">&quot;-Xclang&quot;</span>, <span class="hljs-string">&quot;-analyzer-display-progress&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">foreach</span> <span class="hljs-keyword">my</span> $arg (@$AnalyzeArgs) &#123;<br>      <span class="hljs-keyword">push</span> @Args, <span class="hljs-string">&quot;-Xclang&quot;</span>, $arg;<br>    &#125;<br><br>    <span class="hljs-comment"># Display Ubiviz graph?</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">defined</span> $ENV&#123;<span class="hljs-string">&#x27;CCC_UBI&#x27;</span>&#125;) &#123;<br>      <span class="hljs-keyword">push</span> @Args, <span class="hljs-string">&quot;-Xclang&quot;</span>, <span class="hljs-string">&quot;-analyzer-viz-egraph-ubigraph&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">my</span> $AnalysisArgs = GetCCArgs(<span class="hljs-string">&quot;--analyze&quot;</span>, \@Args);<br>    @CmdArgs = @$AnalysisArgs;<br>  &#125;<br><br>  <span class="hljs-keyword">my</span> @PrintArgs;<br>  <span class="hljs-keyword">my</span> $dir;<br><br>  <span class="hljs-keyword">if</span> ($Verbose) &#123;<br>    $dir = getcwd();<br>    <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">&quot;\n[LOCATION]: $dir\n&quot;</span>;<br>    <span class="hljs-keyword">push</span> @PrintArgs,<span class="hljs-string">&quot;&#x27;$Cmd&#x27;&quot;</span>;<br>    <span class="hljs-keyword">foreach</span> <span class="hljs-keyword">my</span> $arg (@CmdArgs) &#123;<br>        <span class="hljs-keyword">push</span> @PrintArgs,<span class="hljs-string">&quot;\&#x27;$arg\&#x27;&quot;</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ($Verbose == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment"># We MUST print to stderr.  Some clients use the stdout output of</span><br>    <span class="hljs-comment"># gcc for various purposes.</span><br>    <span class="hljs-keyword">print</span> STDERR <span class="hljs-keyword">join</span>(<span class="hljs-string">&#x27; &#x27;</span>, @PrintArgs);<br>    <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">&quot;\n&quot;</span>;<br>  &#125;<br>  <span class="hljs-keyword">elsif</span> ($Verbose == <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">&quot;#SHELL (cd &#x27;$dir&#x27; &amp;&amp; @PrintArgs)\n&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-comment"># Capture the STDERR of clang and send it to a temporary file.</span><br>  <span class="hljs-comment"># Capture the STDOUT of clang and reroute it to ccc-analyzer&#x27;s STDERR.</span><br>  <span class="hljs-comment"># We save the output file in the &#x27;crashes&#x27; directory if clang encounters</span><br>  <span class="hljs-comment"># any problems with the file.</span><br>  <span class="hljs-keyword">pipe</span> (FROM_CHILD, TO_PARENT);<br>  <span class="hljs-keyword">my</span> $pid = <span class="hljs-keyword">fork</span>();<br>  <span class="hljs-keyword">if</span> ($pid == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">close</span> FROM_CHILD;<br>    <span class="hljs-keyword">open</span>(STDOUT,<span class="hljs-string">&quot;&gt;&amp;&quot;</span>, \*TO_PARENT);<br>    <span class="hljs-keyword">open</span>(STDERR,<span class="hljs-string">&quot;&gt;&amp;&quot;</span>, \*TO_PARENT);<br>    <span class="hljs-keyword">exec</span> $Cmd, @CmdArgs;<br>  &#125;<br><br>  <span class="hljs-keyword">close</span> TO_PARENT;<br>  <span class="hljs-keyword">my</span> ($ofh, $ofile) = tempfile(<span class="hljs-string">&quot;clang_output_XXXXXX&quot;</span>, <span class="hljs-string">DIR =&gt;</span> $HtmlDir);<br>  <span class="hljs-keyword">my</span> $fss_file = abs_path($file);<br>  <span class="hljs-keyword">my</span> @dentry = <span class="hljs-keyword">split</span>(<span class="hljs-regexp">/\//</span>, $fss_file);<br>  <span class="hljs-keyword">my</span> $start = ($#dentry &gt;= <span class="hljs-number">3</span>) ? $#dentry - <span class="hljs-number">3</span> : <span class="hljs-number">0</span>;<br>  $fss_file  = <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;HtmlDir&#125;</span>/&quot;</span>;<br>  <span class="hljs-keyword">for</span> <span class="hljs-keyword">my</span> $i ($start .. $#dentry)<br>  &#123;<br>      <span class="hljs-keyword">if</span> ($i == $#dentry) &#123;<br>	  <span class="hljs-keyword">system</span> <span class="hljs-string">&quot;mkdir -p <span class="hljs-subst">$&#123;fss_file&#125;</span>&quot;</span>;<br>	  <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;[XXXX] <span class="hljs-subst">$&#123;fss_file&#125;</span>\n&quot;</span>;<br>      &#125;<br>      $fss_file = <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;fss_file&#125;</span>/<span class="hljs-subst">$&#123;dentry[$i]&#125;</span>&quot;</span>;<br>  &#125;<br>  <span class="hljs-keyword">open</span>(<span class="hljs-keyword">my</span> $fss_fh, <span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;fss_file&#125;</span>.fss&quot;</span>)  <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span> <span class="hljs-string">&quot;Cannot open $fss_file\n&quot;</span>;<br><br>  <span class="hljs-keyword">my</span> $is_path = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (&lt;FROM_CHILD&gt;) &#123;<br>    <span class="hljs-keyword">print</span> $ofh $_;<br>    <span class="hljs-keyword">print</span> STDERR $_;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^@@&lt;&lt;/</span>) &#123;<br>      $is_path = <span class="hljs-number">1</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> ($is_path) &#123;<br>      <span class="hljs-keyword">print</span> $fss_fh $_<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^@@&gt;&gt;/</span>) &#123;<br>      $is_path = <span class="hljs-number">0</span>;<br>    &#125;	<br>  &#125;<br>  <span class="hljs-keyword">close</span> $ofh;<br>  <span class="hljs-keyword">close</span> $fss_fh;<br><br>  <span class="hljs-keyword">waitpid</span>($pid,<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">close</span>(FROM_CHILD);<br>  <span class="hljs-keyword">my</span> $Result = $?;<br><br>  <span class="hljs-comment"># Did the command die because of a signal?</span><br>  <span class="hljs-keyword">if</span> ($ReportFailures) &#123;<br>    <span class="hljs-keyword">if</span> ($Result &amp; <span class="hljs-number">127</span> <span class="hljs-keyword">and</span> $Cmd eq $Clang <span class="hljs-keyword">and</span> <span class="hljs-keyword">defined</span> $HtmlDir) &#123;<br>      ProcessClangFailure($Clang, $Lang, $file, \@CmdArgsSansAnalyses,<br>                          $HtmlDir, <span class="hljs-string">&quot;Crash&quot;</span>, $ofile);<br>    &#125;<br>    <span class="hljs-keyword">elsif</span> ($Result) &#123;<br>      <span class="hljs-keyword">if</span> ($IncludeParserRejects &amp;&amp; !($file =~<span class="hljs-regexp">/conftest/</span>)) &#123;<br>        ProcessClangFailure($Clang, $Lang, $file, \@CmdArgsSansAnalyses,<br>                            $HtmlDir, $ParserRejects, $ofile);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        ProcessClangFailure($Clang, $Lang, $file, \@CmdArgsSansAnalyses,<br>                            $HtmlDir, $OtherError, $ofile);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment"># Check if there were any unhandled attributes.</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">open</span>(CHILD, $ofile)) &#123;<br>        <span class="hljs-keyword">my</span> %attributes_not_handled;<br><br>        <span class="hljs-comment"># Don&#x27;t flag warnings about the following attributes that we</span><br>        <span class="hljs-comment"># know are currently not supported by Clang.</span><br>        $attributes_not_handled&#123;<span class="hljs-string">&quot;cdecl&quot;</span>&#125; = <span class="hljs-number">1</span>;<br><br>        <span class="hljs-keyword">my</span> $ppfile;<br>        <span class="hljs-keyword">while</span> (&lt;CHILD&gt;) &#123;<br>          <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> (! <span class="hljs-regexp">/warning: &#x27;([^\&#x27;]+)&#x27; attribute ignored/</span>);<br><br>          <span class="hljs-comment"># Have we already spotted this unhandled attribute?</span><br>          <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">defined</span> $attributes_not_handled&#123;$1&#125;);<br>          $attributes_not_handled&#123;$1&#125; = <span class="hljs-number">1</span>;<br><br>          <span class="hljs-comment"># Get the name of the attribute file.</span><br>          <span class="hljs-keyword">my</span> $dir = <span class="hljs-string">&quot;$HtmlDir/failures&quot;</span>;<br>          <span class="hljs-keyword">my</span> $afile = <span class="hljs-string">&quot;$dir/attribute_ignored_$1.txt&quot;</span>;<br><br>          <span class="hljs-comment"># Only create another preprocessed file if the attribute file</span><br>          <span class="hljs-comment"># doesn&#x27;t exist yet.</span><br>          <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> (-e $afile);<br><br>          <span class="hljs-comment"># Add this file to the list of files that contained this attribute.</span><br>          <span class="hljs-comment"># Generate a preprocessed file if we haven&#x27;t already.</span><br>          <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">defined</span> $ppfile)) &#123;<br>            $ppfile = ProcessClangFailure($Clang, $Lang, $file,<br>                                          \@CmdArgsSansAnalyses,<br>                                          $HtmlDir, $AttributeIgnored, $ofile);<br>          &#125;<br><br>          mkpath $dir;<br>          <span class="hljs-keyword">open</span>(AFILE, <span class="hljs-string">&quot;&gt;$afile&quot;</span>);<br>          <span class="hljs-keyword">print</span> AFILE <span class="hljs-string">&quot;$ppfile\n&quot;</span>;<br>          <span class="hljs-keyword">close</span>(AFILE);<br>        &#125;<br>        <span class="hljs-keyword">close</span> CHILD;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">unlink</span>($ofile);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Analyze</code> 函数接受多个参数，包括 <code>$Clang</code>（Clang 编译器的路径）、<code>$OriginalArgs</code>（原始的编译选项和参数数组）、<code>$AnalyzeArgs</code>（分析相关的选项数组）、<code>$Lang</code>（文件的语言类型）、<code>$Output</code>（输出文件名）、<code>$Verbose</code>（详细程度）、<code>$HtmlDir</code>（HTML 输出目录，实际上也用作<code>clang-log</code>输出目录，只不过和HTML无关）和 <code>$file</code>（要处理的文件名）。</p>
<p>首先，函数检查 <code>$Lang</code> 是否包含 "header"，如果是，说明要处理的文件是头文件，而不是源代码文件。如果 <code>$Output</code> 未定义，就退出，否则执行文件拷贝操作。 如果不是头文件，函数将构建用于执行 Clang 静态代码分析的命令参数。它使用 <code>GetCCArgs</code> 函数获取了语法分析的参数（<code>$SyntaxArgs</code>）和静态分析的参数（<code>@CmdArgs</code>）。</p>
<p>函数通过 <code>fork</code> 创建了一个子进程，然后在子进程中执行 Clang 命令，进行语法分析和静态分析。它使用 <code>pipe</code> 创建了两个管道，分别用于捕获 Clang 的标准输出和标准错误。然后，子进程将标准输出和标准错误重定向到这两个管道，并执行 Clang 命令。</p>
<p>父进程中，函数会从管道中读取 Clang 的标准输出和标准错误，并将它们同时输出到标准错误流和一个临时文件（<code>$ofile</code>）中。在处理输出的过程中，它还会检测是否遇到特定的标记（<code>@@&lt;&lt;</code> 和 <code>@@&gt;&gt;</code>），它将标记之间的内容写入一个名为 <code>one.cs.fss</code> 的文件中，用于后续的分析。</p>
<p>与 <code>fssccc-analyzer</code> 脚本同一目录下的 <code>fssc++-analyzer</code> 脚本通过直接调用 <code>fssccc-analyzer</code> 脚本来进行语法分析和静态分析。</p>
<h2 id="结果分析">结果分析</h2>
<p>TODO</p>
<h2 id="改进">改进</h2>
<p>TODO</p>
<p>向量数据库？ 相关系数矩阵？协方差矩阵？等传统数学建模技术</p>

      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/09/03/Hyperkernel:%20Push-Button%20Verification%20of%20an%20OS%20Kernel%20%E9%98%85%E8%AF%BB/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>Hyperkernel: Push-Button Verification of an OS Kernel 阅读</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/08/31/icns%20%E5%88%B6%E4%BD%9C/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      icns 图标制作
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/Linux/" class="post-tag">#Linux</a><a href="/tags/File-System/" class="post-tag">#File System</a><a href="/tags/Paper/" class="post-tag">#Paper</a><a href="/tags/Symbolic-Execution/" class="post-tag">#Symbolic Execution</a><a href="/tags/Staitc-Analysis/" class="post-tag">#Staitc Analysis</a><a href="/tags/SOSP/" class="post-tag">#SOSP</a><a href="/tags/SOSP-15/" class="post-tag">#SOSP'15</a>

</div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="/2023/09/07/SibylFS: formal specification and oracle-based testing for POSIX and real-world file systems 阅读/" title="SibylFS: formal specification and oracle-based testing for POSIX and real-world file systems 阅读" rel="bookmark">SibylFS: formal specification and oracle-based testing for POSIX and real-world file systems 阅读</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/09/03/Hyperkernel: Push-Button Verification of an OS Kernel 阅读/" title="Hyperkernel: Push-Button Verification of an OS Kernel 阅读" rel="bookmark">Hyperkernel: Push-Button Verification of an OS Kernel 阅读</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/09/18/Scaling symbolic evaluation for automated verification of systems code with Serval 阅读/" title="Scaling symbolic evaluation for automated verification of systems code with Serval 阅读" rel="bookmark">Scaling symbolic evaluation for automated verification of systems code with Serval 阅读</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/11/07/@蓝色老师的LLVM系列文章汇总/" title="@蓝色老师的LLVM系列文章汇总" rel="bookmark">@蓝色老师的LLVM系列文章汇总</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/09/06/All File Systems Are Not Created Equal: On the Complexity of Crafting Crash-Consistent Applications 阅读/" title="All File Systems Are Not Created Equal: On the Complexity of Crafting Crash-Consistent Applications 阅读" rel="bookmark">All File Systems Are Not Created Equal: On the Complexity of Crafting Crash-Consistent Applications 阅读</a></div></div></div>
    
  </div>
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              
                <div class="matts">海</div>
              
                <div class="matts">内</div>
              
                <div class="matts">存</div>
              
                <div class="matts">知</div>
              
                <div class="matts">己</div>
              
            </div>
          
            <div class="foot-line">
              
                <div class="matts">天</div>
              
                <div class="matts">涯</div>
              
                <div class="matts">若</div>
              
                <div class="matts">比</div>
              
                <div class="matts">邻</div>
              
            </div>
          
        </div>
        <div class="foot__body">
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/jtzhpf">github</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:jtzhpf@126.com">jtzhpf@126.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://zpf.pages.dev">ZPF.SITE</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/>
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/>
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/>
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
    
  
  <script src="https://utteranc.es/client.js"
        repo="jtzhpf/jtzhpf.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


  </body>
</html>