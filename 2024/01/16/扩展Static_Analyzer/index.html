<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8"/>
    <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
    <title>
      
        扩展 Static Analyzer | ZPF.SITE
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png"/>
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color=""/>
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/regular.ttf);
        font-weight: regular;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css'/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg"/>
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/CS&Maths">Computer Science & Maths</a>
            
              <a class="nav-menu-item" href="/Life">Life</a>
            
          
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner--toc">
      <div class="post-content__head">
        <div class="post-title">扩展 Static Analyzer</div>
        <div class="post-info">
          
  <a href="/tags/LLVM/" class="post-tag">#LLVM</a><a href="/tags/Clang/" class="post-tag">#Clang</a><a href="/tags/Compiler/" class="post-tag">#Compiler</a><a href="/tags/Symbolic-Execution/" class="post-tag">#Symbolic Execution</a><a href="/tags/Static-Analysis/" class="post-tag">#Static Analysis</a>


          <span class="post-date">2024-01-16</span>
        </div>
      </div>
      
        <aside class="toc-outer">
          <div class="toc-title">目录</div>
          <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%89%B9%E6%AE%8A%E9%9C%80%E6%B1%82"><span class="post-toc-text">特殊需求</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#programstate-%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="post-toc-text">ProgramState 不可变</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AE%9A%E4%B9%89-onoffchecker"><span class="post-toc-text">定义 OnOffChecker</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%B3%A8%E5%86%8C%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="post-toc-text">注册映射关系</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0-onoffchecker"><span class="post-toc-text">实现 OnOffChecker</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%B3%A8%E5%86%8C"><span class="post-toc-text">注册</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="post-toc-text">执行结果</span></a></li></ol>
          <a href="#" class="toc-top">回到顶部</a>
        </aside>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <p>Static Analyzer中三个至关重要的数据结构是ProgramState、ProgramPoint和ExplodedGraph。</p>
<p>考虑此例： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">my_function</span><span class="hljs-params">(<span class="hljs-type">int</span> unknownvalue)</span> &#123;<br>  <span class="hljs-type">int</span> schroedinger_integer;<br>  <span class="hljs-keyword">if</span> (unknownvalue)<br>    schroedinger_integer = <span class="hljs-number">5</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hi&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!unknownvalue)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>, schroedinger_integer);<br>&#125;<br></code></pre></td></tr></table></figure> <code>ProgramState</code>表示相对于当前状态的当前执行上下文。例如，在分析如上的代码时，它会注明某个变量具有值5。</p>
<p><code>ProgramPoint</code>表示程序流中的特定点，可以是语句之前或之后，例如，将整数变量赋值为5之后的点。</p>
<p><code>ExplodedGraph</code>表示可达程序状态的整个图。<code>ExplodedGraph</code>，或者说可达状态图，是对经典控制流图（CFG）的扩展。<code>ExplodedNode</code>继承自LLVM库的superclass <code>llvm::FoldingSetNode</code>。折叠在编译器的中间和后端广泛使用，LLVM库已经包括了一个用于这些情况的通用类。此图的节点由<code>ProgramState</code>和<code>ProgramPoint</code>的元组表示，这意味着每个程序点都与特定状态相关联。例如，将整数变量赋值为5之后的点具有将该变量链接到数字5的状态。</p>
<p>静态分析器的整体设计可以分为以下几个部分：</p>
<ul>
<li>engine：按照模拟路径并管理其他组件；</li>
<li>state manager：负责处理ProgramState对象；</li>
<li>constraint manager：用于推断由于按照给定程序路径进行的ProgramState引起的约束；</li>
<li>store manager：负责程序存储模型。</li>
</ul>
<h1 id="特殊需求">特殊需求</h1>
<p>假设现在有如下程序： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">Off</span><span class="hljs-params">()</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">On</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">test_loop</span><span class="hljs-params">(<span class="hljs-type">int</span> wrongTemperature, <span class="hljs-type">int</span> restart)</span> &#123;<br>    On();<br>    <span class="hljs-keyword">if</span> (wrongTemperature) &#123;<br>        Off();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (restart) &#123;<br>        Off();<br>    &#125;<br>    On();<br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// code to keep working</span><br>    <span class="hljs-comment">//</span><br>    Off();<br>&#125;<br></code></pre></td></tr></table></figure> 要求<code>On()</code>和<code>Off()</code>不得连续执行2次。<br />
如果<code>wrongTemperature</code>和<code>restart</code>同时不为0，则连续调用<code>Off()</code>2次，违反规则。<br />
如果<code>wrongTemperature</code>和<code>restart</code>同时为0，则连续调用<code>On()</code>2次，也违反规则。</p>
<h2 id="programstate-不可变">ProgramState 不可变</h2>
<p><code>ProgramState</code>被设计成不可变的。一旦构建完成，它就不应该再发生改变。这是因为<code>ProgramState</code>表示为给定执行路径中的特定程序点计算的状态。不同于处理控制流图（CFG）的数据流分析，这里我们处理的是可达程序状态图，该图为每个不同的程序点和状态组合都有一个不同的节点。</p>
<p>当程序中存在循环时，引擎将创建一个全新的路径，记录有关这个新迭代的相关信息。这种方法确保了在不同迭代中能够保留先前计算的状态信息。</p>
<p>然而，在处理循环时，引擎也考虑了性能和避免重复计算的问题。如果引擎达到一个节点，该节点表示具有相同状态的给定循环体的相同程序点，引擎会断定在这条路径上没有新信息需要处理，并选择重用该节点而不是创建新的节点。这样做的目的是避免不必要的计算和提高性能。</p>
<p>另一方面，如果循环体不断使用新信息更新状态，符号引擎可能会面临限制。在模拟预定义次数的迭代后，符号引擎可能会放弃此路径，这个预定义次数在启动工具时是可配置的。这是为了防止无限循环或长时间运行的情况，同时也是一种权衡性能和分析深度的策略。</p>
<p>如上所述，我们的<code>OnOffState</code>中不必进行状态的修改。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ClangSACheckers.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;clang/StaticAnalyzer/Core/BugReporter/BugType.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;clang/StaticAnalyzer/Core/Checker.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;clang/StaticAnalyzer/Core/CheckerManager.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;clang/StaticAnalyzer/Core/PathSensitive/CallEvent.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;clang/StaticAnalyzer/Core/PathSensitive/CheckerContext.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> clang;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ento;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OnOffState</span> &#123;<br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Kind</span> &#123; On, Off &#125; K;<br><br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">OnOffState</span>(<span class="hljs-type">unsigned</span> InK) : <span class="hljs-built_in">K</span>((Kind)InK) &#123;&#125;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isOn</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> K == On; &#125;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isOff</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> K == Off; &#125;<br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-title">getOn</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span>)On; &#125;<br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-title">getOff</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span>)Off; &#125;<br>  <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> OnOffState &amp;X) <span class="hljs-type">const</span> &#123; <span class="hljs-keyword">return</span> K == X.K; &#125;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Profile</span><span class="hljs-params">(llvm::FoldingSetNodeID &amp;ID)</span> <span class="hljs-type">const</span> </span>&#123; ID.<span class="hljs-built_in">AddInteger</span>(K); &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>Profile</code>函数的存在是为了满足<code>ExplodedNode</code>作为<code>FoldingSetNode</code>子类的要求。所有的子类都必须提供这样的方法，以帮助LLVM的折叠机制追踪节点的状态，并确定两个节点是否相等（在这种情况下，它们会被折叠）。因此，<code>Profile</code>函数用<code>K</code>给出了我们的状态。</p>
<p>对于<code>FoldingSetNode</code>，可以使用任何以<code>Add</code>开头的成员函数来通知唯一的位，以标识此对象实例（参见<code>llvm/ADT/FoldingSet.h</code>）。</p>
<p>简而言之，<code>Profile</code>函数用于为<code>ExplodedNode</code>对象实例创建一个唯一的标识符，以便在LLVM的折叠机制中追踪和管理这些节点。通过使用<code>AddInteger()</code>函数，<code>K</code>的数值被添加到唯一标识符中，这对于正确实现节点的折叠和唯一性检查是至关重要的。</p>
<h1 id="定义-onoffchecker">定义 OnOffChecker</h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OnOffChecker</span> : <span class="hljs-keyword">public</span> Checker&lt;check::PostCall&gt; &#123;<br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">mutable</span> IdentifierInfo *IIOn, *IIOff;<br>  <span class="hljs-keyword">mutable</span> std::unique_ptr&lt;BugType&gt; DoubleOffBugType;<br>  <span class="hljs-keyword">mutable</span> std::unique_ptr&lt;BugType&gt; DoubleOnBugType;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initIdentifierInfo</span><span class="hljs-params">(ASTContext &amp;Ctx)</span> <span class="hljs-type">const</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reportDoubleOff</span><span class="hljs-params">(<span class="hljs-type">const</span> CallEvent &amp;Call, CheckerContext &amp;C)</span> <span class="hljs-type">const</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reportDoubleOn</span><span class="hljs-params">(<span class="hljs-type">const</span> CallEvent &amp;Call, CheckerContext &amp;C)</span> <span class="hljs-type">const</span></span>;<br><br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">OnOffChecker</span>();<br>  <span class="hljs-comment">/// Process on and off</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checkPostCall</span><span class="hljs-params">(<span class="hljs-type">const</span> CallEvent &amp;Call, CheckerContext &amp;C)</span> <span class="hljs-type">const</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>类的开头表明我们正在使用一个具有模板参数的 <code>Checker</code> 子类。对于这个类，你可以使用多个模板参数，它们表示你的检查器感兴趣访问的程序点。我们的检查器将从基类继承 <code>PostCall</code>。这种继承用于实现访问者模式，它将仅为我们感兴趣的对象调用我们，因此，我们的类必须实现成员函数 <code>checkPostCall</code>。</p>
<p>各种类型的程序点可见于 <code>CheckerDocumentation.cpp</code>。在我们的情况下，我们希望访问调用后的程序点，因为我们想要记录在调用函数之后状态的变化。</p>
<p>为了通知 Clang 我们正在处理新类型的错误，我们需要创建新的 <code>BugType</code> 实例。在这段代码中，有两个不同的 <code>BugType</code> 实例，分别用于报告两种不同的错误情况：当程序员调用 <code>On()</code> 两次和调用 <code>Off()</code> 两次时发生的错误。</p>
<h1 id="注册映射关系">注册映射关系</h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">REGISTER_MAP_WITH_PROGRAMSTATE</span>(OOS, <span class="hljs-type">int</span>, OnOffState)<br></code></pre></td></tr></table></figure>
<p><code>REGISTER_MAP_WITH_PROGRAMSTATE</code> 是一个宏，用来在 <code>ProgramState</code> 中注册两个类型之间的映射关系。</p>
<p>第一个参数是 <code>map</code> 的名称，第二个参数是 <code>key</code> 的类型，第三个参数是 <code>value</code> 的类型。</p>
<p>所以这行代码表示在 <code>ProgramState</code> 中注册名为 <code>OOS</code> 的 <code>map</code>，<code>key</code> 的类型是 <code>int</code>，<code>value</code> 的类型是 <code>OnOffState</code>。</p>
<p>实际上我们不需要繁多的映射关系，因为我们在每个程序点始终只存储一个状态。因此，我们将始终使用键 1 来访问我们的映射。</p>
<p>要了解将信息注册到程序状态的其他方式，请查看 <code>CheckerContext.h</code> 中的宏定义。</p>
<h1 id="实现-onoffchecker">实现 OnOffChecker</h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++">OnOffChecker::<span class="hljs-built_in">OnOffChecker</span>() : <span class="hljs-built_in">IIOn</span>(<span class="hljs-number">0</span>), <span class="hljs-built_in">IIOff</span>(<span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-comment">// Initialize the bug types.</span><br>  DoubleOffBugType.<span class="hljs-built_in">reset</span>(<br>      <span class="hljs-keyword">new</span> <span class="hljs-built_in">BugType</span>(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;Double Off&quot;</span>, <span class="hljs-string">&quot;On and Off Test Error&quot;</span>));<br>  DoubleOnBugType.<span class="hljs-built_in">reset</span>(<br>      <span class="hljs-keyword">new</span> <span class="hljs-built_in">BugType</span>(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;Double On&quot;</span>, <span class="hljs-string">&quot;On and Off Test Error&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>构造函数通过使用 <code>unique_ptr</code> 的 <code>reset()</code> 成员函数实例化了新的 <code>BugType</code> 对象。三个参数分别为checker、bug名称、bug类别。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnOffChecker::initIdentifierInfo</span><span class="hljs-params">(ASTContext &amp;Ctx)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (IIOn)<br>    <span class="hljs-keyword">return</span>;<br>  IIOn = &amp;Ctx.Idents.<span class="hljs-built_in">get</span>(<span class="hljs-string">&quot;On&quot;</span>);<br>  IIOff = &amp;Ctx.Idents.<span class="hljs-built_in">get</span>(<span class="hljs-string">&quot;Off&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>ASTContext</code> 对象保存了包含用户程序中使用的类型和声明的特定 AST 节点，<code>Idents</code>是<code>IdentifierTable</code>类型，我们可以使用它来找到我们有兴趣监视的函数的确切标识符。此处监视函数<code>On()</code>和<code>Off()</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnOffChecker::checkPostCall</span><span class="hljs-params">(<span class="hljs-type">const</span> CallEvent &amp;Call,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 CheckerContext &amp;C)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">initIdentifierInfo</span>(C.<span class="hljs-built_in">getASTContext</span>());<br><br>  <span class="hljs-keyword">if</span> (!Call.<span class="hljs-built_in">isGlobalCFunction</span>())<br>    <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">if</span> (Call.<span class="hljs-built_in">getCalleeIdentifier</span>() == IIOn) &#123;<br>    ProgramStateRef State = C.<span class="hljs-built_in">getState</span>();<br>    <span class="hljs-type">const</span> OnOffState *S = State-&gt;<span class="hljs-built_in">get</span>&lt;OOS&gt;(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (S &amp;&amp; S-&gt;<span class="hljs-built_in">isOn</span>()) &#123;<br>      <span class="hljs-built_in">reportDoubleOn</span>(Call, C);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    State = State-&gt;<span class="hljs-built_in">set</span>&lt;OOS&gt;(<span class="hljs-number">1</span>, OnOffState::<span class="hljs-built_in">getOn</span>());<br>    C.<span class="hljs-built_in">addTransition</span>(State);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (Call.<span class="hljs-built_in">getCalleeIdentifier</span>() == IIOff) &#123;<br>    ProgramStateRef State = C.<span class="hljs-built_in">getState</span>();<br>    <span class="hljs-type">const</span> OnOffState *S = State-&gt;<span class="hljs-built_in">get</span>&lt;OOS&gt;(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (S &amp;&amp; S-&gt;<span class="hljs-built_in">isOff</span>()) &#123;<br>      <span class="hljs-built_in">reportDoubleOff</span>(Call, C);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    State = State-&gt;<span class="hljs-built_in">set</span>&lt;OOS&gt;(<span class="hljs-number">1</span>, OnOffState::<span class="hljs-built_in">getOff</span>());<br>    C.<span class="hljs-built_in">addTransition</span>(State);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>checkPostCall</code> 是 <code>const</code> function，不应该修改 checker 的状态。</p>
<p>第一个参数 - <code>CallEvent</code> 类型：</p>
<ul>
<li>该参数保存有关程序在此程序点之前调用的确切函数的信息。这是因为我们注册了一个调用后的访问器（post-call visitor）。</li>
<li>在这里，我们使用 <code>CallEvent</code> 对象来检查是否调用了 <code>On()``Off()</code> 函数。</li>
</ul>
<p>第二个参数 - <code>CheckerContext</code> 类型：</p>
<ul>
<li>这个参数是在此程序点唯一提供当前状态信息的源，因为我们的检查器被强制保持无状态。</li>
<li>我们使用这个参数来检索 <code>ASTContext</code> 并初始化我们的 <code>IdentifierInfo</code> 对象，这些对象用于检查我们正在监视的函数。</li>
</ul>
<p>处理流程：</p>
<ul>
<li>我们通过询问 <code>CallEvent</code> 对象来检查是否调用了 <code>On()</code> 函数。如果是，进入处理。</li>
<li><code>ProgramStateRef State = C.getState();</code> 获取当前程序状态。</li>
<li><code>const OnOffState *S = State-&gt;get&lt;OOS&gt;(1);</code> 通过调用 <code>get&lt;OOS&gt;(1)</code> 获取存储在程序状态中的 <code>OnOffState</code> 对象，OOS 是我们注册的映射的名称，1 是映射的位置。
<ul>
<li>如果 <code>S</code> 不为空且确实为<code>On</code> (说明<code>On</code>已经是第二次遇见了)，那么调用 <code>reportDoubleOn(Call, C);</code> 报告错误并返回。</li>
<li>否则，说明这次第一次遇见<code>On</code>，我们将程序状态更新为将 <code>OnOffState</code> 设置为开启状态：<code>State = State-&gt;set&lt;OOS&gt;(1, OnOffState::getOn());</code></li>
</ul></li>
<li>最后，通过 <code>C.addTransition(State);</code> 将新的程序状态传递给 ExplodedGraph 创建新边，记录状态变化。这些边仅在状态实际更改时创建。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnOffChecker::reportDoubleOn</span><span class="hljs-params">(<span class="hljs-type">const</span> CallEvent &amp;Call,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  CheckerContext &amp;C)</span> <span class="hljs-type">const</span> </span>&#123;<br>  ExplodedNode *ErrNode = C.<span class="hljs-built_in">generateSink</span>();<br>  <span class="hljs-keyword">if</span> (!ErrNode)<br>    <span class="hljs-keyword">return</span>;<br>  BugReport *R = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BugReport</span>(*DoubleOnBugType,<br>                               <span class="hljs-string">&quot;Call the On() function two times&quot;</span>, ErrNode);<br>  R-&gt;<span class="hljs-built_in">addRange</span>(Call.<span class="hljs-built_in">getSourceRange</span>());<br>  C.<span class="hljs-built_in">emitReport</span>(R);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>代码中的 <code>generateSink()</code> 意味着在可达程序状态图中生成一个汇聚节点(Sink Node)。这表示在当前路径上发现了一个严重的错误，因此我们不希望继续分析该路径。</p>
<p>第6行代码创建了一个 <code>BugReport</code> 对象，指定了我们发现了一个特定类型 <code>DoubleOnBugType</code> 的新错误，并且我们可以自由地添加描述并提供刚刚构建的错误节点（Sink 节点）。</p>
<p>我们使用 <code>addRange</code> 成员函数将错误位置的源代码范围添加到 <code>BugReport</code> 中。这样，用户在收到错误报告时可以看到源代码中具体发生错误的位置。</p>
<p>最后通过 <code>C.emitReport(R);</code> 向 <code>CheckerContext</code> 发送错误报告，将 <code>BugReport</code> 发送到报告系统，使得错误信息能够在适当的时机被输出或显示给用户。</p>
<h1 id="注册">注册</h1>
<p>将文件名 <code>OnOffChecker.cpp</code> 添加到 <code>lib/StaticAnalyzer/Checkers/CMakeLists.txt</code> 中。</p>
<p>在 <code>lib/StaticAnalyzer/Checkers/Checkers.td</code> 中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tablegen">def PowerPlantAlpha : Package&lt;&quot;powerplant&quot;&gt;, InPackage&lt;Alpha&gt;;<br><br>let ParentPackage = PowerPlantAlpha in &#123;<br>def OnOffChecker : Checker&lt;&quot;OnOffChecker&quot;&gt;,<br>  HelpText&lt;&quot;Check for misuses of the nuclear power plant API&quot;&gt;,<br>  DescFile&lt;&quot;OnOffChecker.cpp&quot;&gt;;<br>&#125; // end &quot;alpha.powerplant&quot;<br></code></pre></td></tr></table></figure>
<h1 id="执行结果">执行结果</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ clang  --analyze -Xanalyzer -analyzer-checker=alpha.powerplant test.c -o test.o<br>test.c:10:9: warning: Call the Off() function two times<br>        Off();<br>        ^~~~~<br>test.c:12:5: warning: Call the On() function two times<br>    On();<br>    ^~~~<br>2 warnings generated.<br></code></pre></td></tr></table></figure>

      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@10.4.0/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize({"startOnload":true});
        }
      </script>
    
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2024/01/17/%E7%90%86%E6%B8%85%E5%B8%B8%E9%87%8F%E6%8C%87%E9%92%88%E5%92%8C%E6%8C%87%E9%92%88%E5%B8%B8%E9%87%8F/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>理清常量指针和指针常量</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2024/01/10/std::enable_if%E7%9A%84%E5%87%A0%E7%A7%8D%E7%94%A8%E6%B3%95/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      C++ std::enable_if 的几种用法
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/LLVM/" class="post-tag">#LLVM</a><a href="/tags/Clang/" class="post-tag">#Clang</a><a href="/tags/Compiler/" class="post-tag">#Compiler</a><a href="/tags/Symbolic-Execution/" class="post-tag">#Symbolic Execution</a><a href="/tags/Static-Analysis/" class="post-tag">#Static Analysis</a>

</div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="/2023/11/22/Clang_Static_Analyzer/" title="Clang Static Analyzer" rel="bookmark">Clang Static Analyzer</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/11/21/Getting_Started_with_LLVM_Core_Libraries阅读/" title="Getting Started with LLVM Core Libraries 阅读" rel="bookmark">Getting Started with LLVM Core Libraries 阅读</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/11/07/@蓝色老师的LLVM系列文章汇总/" title="@蓝色老师的LLVM系列文章汇总" rel="bookmark">@蓝色老师的LLVM系列文章汇总</a></div></div><div class="null-item"><div class="null-title"><a href="/2024/01/03/AddressSanitizer/" title="AddressSanitizer" rel="bookmark">AddressSanitizer</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/09/06/All_File_Systems_Are_Not_Created_Equal:On_the_Complexity_of_Crafting_Crash-Consistent_Applications阅读/" title="All File Systems Are Not Created Equal: On the Complexity of Crafting Crash-Consistent Applications 阅读" rel="bookmark">All File Systems Are Not Created Equal: On the Complexity of Crafting Crash-Consistent Applications 阅读</a></div></div></div>
    
  </div>
</div>

    
    
    
      <script src="https://utteranc.es/client.js"
    repo="jtzhpf/jtzhpf.github.io"
    issue-term="pathname"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              
                <div class="matts">海</div>
              
                <div class="matts">内</div>
              
                <div class="matts">存</div>
              
                <div class="matts">知</div>
              
                <div class="matts">己</div>
              
            </div>
          
            <div class="foot-line">
              
                <div class="matts">天</div>
              
                <div class="matts">涯</div>
              
                <div class="matts">若</div>
              
                <div class="matts">比</div>
              
                <div class="matts">邻</div>
              
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">朋友</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://dzc2000.github.io">诚</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://nuistgy.github.io/">宇</a>
                  </div>
                
                <div class="text">
                  <img alt="link" height="20px" width="20px" src="/images/icon/icon-link+.svg"/>
                  <a class="foot-link"
                     href="mailto:jtzhpf@126.com?subject=%E7%94%B3%E8%AF%B7%20ZPF.SITE%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  申请友链</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/jtzhpf">github</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:jtzhpf@126.com">jtzhpf@126.com</a>
              </div>
            </div>
          </div>
          <div class="foot-item">
            <div class="foot-item__head">访客</div>
            <div class="foot-item__body">
              <div class="text">
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
                <span class="post-meta-divider"> &nbsp;|&nbsp; </span>
                <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://zpf.pages.dev">ZPF.SITE</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/>
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/>
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/>
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/jtzhpf/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://unpkg.com/js-polyfills@0.1.43/es6.js"></script>
      <script id="MathJax-script"
              async
              src="https://www.unpkg.com/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    
    
    <script src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.4.0/mermaid.min.js"></script>
    
    
  

  </body>
</html>